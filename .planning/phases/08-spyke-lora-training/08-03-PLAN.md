---
phase: 08-spyke-lora-training
plan: "03"
type: execute
wave: 3
depends_on:
  - "08-01"
  - "08-02"
files_modified: []
autonomous: false
requirements:
  - LORA-02
  - LORA-03
  - LORA-05
must_haves:
  truths:
    - "The selected LoRA file is present at ~/tools/ComfyUI/models/loras/spyke_plasma_v1.safetensors"
    - "The selected checkpoint was chosen by testing all 5 candidates against 3 test prompts (not just defaulting to the final step)"
    - "Test generations show Spyke's asymmetric details: right bracer, left knee pauldron, ginger hair, white cloak"
    - "Only Spyke LoRA is trained and deployed — no June or Draster LoRAs (deferred to v2.1)"
  artifacts:
    - path: "~/tools/ComfyUI/models/loras/spyke_plasma_v1.safetensors"
      provides: "Production Spyke LoRA available for ComfyUI inference"
  key_links:
    - from: "output/loras/spyke/spyke_plasma_v1-step{SELECTED}.safetensors"
      to: "~/tools/ComfyUI/models/loras/spyke_plasma_v1.safetensors"
      via: "cp command after checkpoint selection"
      pattern: "spyke_plasma_v1\\.safetensors"
---

<objective>
Test each saved checkpoint (steps 200, 400, 600, 800, and 920 final) by loading them in ComfyUI and running 3 standard test prompts. Select the best-generalizing checkpoint — not necessarily the final step — and copy it to ~/tools/ComfyUI/models/loras/ as the production LoRA.

Purpose: LORA-02 explicitly requires selecting the best-generalizing checkpoint, not defaulting to the final step. Small datasets (23 images) commonly overfit at later checkpoints. LORA-03 gates Phase 9 — without the LoRA in ComfyUI's loras directory, the inference pipeline cannot wire it into workflows.
Output: spyke_plasma_v1.safetensors in ~/tools/ComfyUI/models/loras/, selected from empirical testing.
</objective>

<execution_context>
@/Users/dondemetrius/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dondemetrius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-spyke-lora-training/08-RESEARCH.md
@.planning/phases/08-spyke-lora-training/08-spyke-lora-training-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prepare ComfyUI for checkpoint testing</name>
  <files></files>
  <action>
Create the loras directory if it does not exist and list all available checkpoints:

```bash
mkdir -p ~/tools/ComfyUI/models/loras/

# List all training output files
ls -lh /Users/dondemetrius/Code/plasma/output/loras/spyke/
```

Expected files (5 total):
```
spyke_plasma_v1-step00000200.safetensors
spyke_plasma_v1-step00000400.safetensors
spyke_plasma_v1-step00000600.safetensors
spyke_plasma_v1-step00000800.safetensors
spyke_plasma_v1.safetensors
```

Copy all 5 checkpoint files to ComfyUI's loras directory so they can be loaded individually in the ComfyUI UI during testing (ComfyUI refreshes the loras list when you click "Refresh" in the model picker):

```bash
cp /Users/dondemetrius/Code/plasma/output/loras/spyke/spyke_plasma_v1-step00000200.safetensors ~/tools/ComfyUI/models/loras/spyke_plasma_v1_step200.safetensors
cp /Users/dondemetrius/Code/plasma/output/loras/spyke/spyke_plasma_v1-step00000400.safetensors ~/tools/ComfyUI/models/loras/spyke_plasma_v1_step400.safetensors
cp /Users/dondemetrius/Code/plasma/output/loras/spyke/spyke_plasma_v1-step00000600.safetensors ~/tools/ComfyUI/models/loras/spyke_plasma_v1_step600.safetensors
cp /Users/dondemetrius/Code/plasma/output/loras/spyke/spyke_plasma_v1-step00000800.safetensors ~/tools/ComfyUI/models/loras/spyke_plasma_v1_step800.safetensors
cp /Users/dondemetrius/Code/plasma/output/loras/spyke/spyke_plasma_v1.safetensors ~/tools/ComfyUI/models/loras/spyke_plasma_v1_final.safetensors
```

Verify copies:
```bash
ls -lh ~/tools/ComfyUI/models/loras/
```
All 5 files should appear.
  </action>
  <verify>
```bash
ls ~/tools/ComfyUI/models/loras/ | grep spyke
```
Output must show 5 files: step200, step400, step600, step800, and final variants.
  </verify>
  <done>5 checkpoint copies exist in ~/tools/ComfyUI/models/loras/ with step-labeled names ready for ComfyUI model picker selection.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Test all 5 checkpoints and select best-generalizing checkpoint</name>
  <files></files>
  <action>
This is a human-run visual evaluation. Start ComfyUI (if not running):
```bash
cd ~/tools/ComfyUI && python main.py
```

Open http://127.0.0.1:8188 in a browser.

Load the txt2img-lora workflow (from the Express service templates at pipeline/express/workflows/txt2img-lora.json) or create a simple workflow manually with:
- Checkpoint: AnythingXL_inkBase
- LoRA: (slot to swap between each checkpoint)
- Sampler: Euler a, 20 steps, CFG 7
- Resolution: 512x512
- Clip skip: 2

Test each of the 5 checkpoints using ALL THREE test prompts. For each prompt, generate 1 image per checkpoint (15 images total).

Test prompt 1 — Trigger word + environment:
```
spyke_plasma_v1, standing in a forest, dramatic lighting, anime style, full body
```

Test prompt 2 — Novel pose (not in training set):
```
spyke_plasma_v1, crouching, looking up at the sky, urban environment, anime style
```

Test prompt 3 — Asymmetric detail consistency check:
```
spyke_plasma_v1, full body, front view, detailed character study, arms at sides, anime style
```

Evaluation criteria for each checkpoint:
- Ginger/orange hair color present?
- White cloak/coat visible?
- RIGHT arm bracer present on the correct side?
- LEFT knee pauldron present on the correct side?
- Art style consistent with training images (not generic anime)?
- Does it generalize to the novel pose (Test 2) without collapsing to a training image copy?

Typical pattern to expect:
- Step 200: Under-trained — generic anime character, trigger word has little effect
- Step 400: Beginning to learn — some Spyke features appear
- Step 600: Often the "sweet spot" — Spyke features present and generalizes to new poses
- Step 800: Good or starting to overfit — check if Test 2 still works
- Step 920 (final): Likely overfit — may only generate images that look like the training set

Selection rule: Choose the checkpoint where Spyke's asymmetric details appear correctly AND the novel pose (Test 2) produces a plausible result. If multiple checkpoints pass, prefer the earlier one.

Resume signal: Type "selected: step{N}" (e.g., "selected: step600" or "selected: final") and describe what you observed. Include which asymmetric details were visible in the selected checkpoint's Test 3 output.
  </action>
  <verify>
User has reviewed all 5 checkpoints against 3 test prompts and selected a specific step checkpoint based on visual generalization quality.
  </verify>
  <done>A specific checkpoint (step 200/400/600/800/final) is selected based on Spyke's asymmetric detail rendering and novel pose generalization — ready for production deployment.</done>
</task>

<task type="auto">
  <name>Task 3: Deploy selected LoRA to ComfyUI production slot</name>
  <files></files>
  <action>
Based on the checkpoint selected in the human verification step, copy the winner to the canonical production path and clean up the evaluation copies.

Replace SELECTED_STEP with the step number chosen (200, 400, 600, 800, or "final"):

```bash
# Copy selected checkpoint as the production LoRA
# Example for step 600 (adjust based on selection):
cp /Users/dondemetrius/Code/plasma/output/loras/spyke/spyke_plasma_v1-step00000600.safetensors \
   ~/tools/ComfyUI/models/loras/spyke_plasma_v1.safetensors

# For final checkpoint (step 920), use instead:
# cp /Users/dondemetrius/Code/plasma/output/loras/spyke/spyke_plasma_v1.safetensors \
#    ~/tools/ComfyUI/models/loras/spyke_plasma_v1.safetensors

# Remove the per-step evaluation copies (keep production copy only)
rm ~/tools/ComfyUI/models/loras/spyke_plasma_v1_step200.safetensors
rm ~/tools/ComfyUI/models/loras/spyke_plasma_v1_step400.safetensors
rm ~/tools/ComfyUI/models/loras/spyke_plasma_v1_step600.safetensors
rm ~/tools/ComfyUI/models/loras/spyke_plasma_v1_step800.safetensors
rm ~/tools/ComfyUI/models/loras/spyke_plasma_v1_final.safetensors
```

LORA-05 confirmation: only Spyke LoRA is deployed. Do NOT create directories or files for June or Draster LoRAs — those are deferred to v2.1.

Verify final state:
```bash
ls -lh ~/tools/ComfyUI/models/loras/
```
Only `spyke_plasma_v1.safetensors` should remain (50-200MB).

The LoRA is now accessible in ComfyUI by the name `spyke_plasma_v1` (filename without extension) — this is the name that Phase 9 will wire into the Express service workflow templates.
  </action>
  <verify>
```bash
ls -lh ~/tools/ComfyUI/models/loras/spyke_plasma_v1.safetensors
```
File exists, between 50MB and 200MB, no other spyke_* evaluation files present.
  </verify>
  <done>~/tools/ComfyUI/models/loras/spyke_plasma_v1.safetensors exists as the single production LoRA file, sourced from the best-generalizing checkpoint. No evaluation copies remain.</done>
</task>

</tasks>

<verification>
1. `ls -lh ~/tools/ComfyUI/models/loras/spyke_plasma_v1.safetensors` — file present, 50-200MB
2. No step-labeled evaluation copies remain in ~/tools/ComfyUI/models/loras/
3. ComfyUI loras model picker shows `spyke_plasma_v1` (requires ComfyUI refresh)
4. Selected checkpoint was tested against all 3 test prompts before selection
5. LORA-05: no June or Draster lora files exist in loras directory
</verification>

<success_criteria>
spyke_plasma_v1.safetensors exists in ~/tools/ComfyUI/models/loras/, sourced from the checkpoint with best generalization across 3 test prompts — Phase 8 is complete and Phase 9 is unblocked.
</success_criteria>

<output>
After completion, create `.planning/phases/08-spyke-lora-training/08-spyke-lora-training-03-SUMMARY.md`
</output>
