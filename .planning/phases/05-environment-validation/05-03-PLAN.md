---
phase: 05-environment-validation
plan: 03
type: execute
wave: 2
depends_on:
  - "05-01"
files_modified:
  - ~/tools/ComfyUI/models/checkpoints/anything-v5-PrtRE.safetensors  # human download
  - ~/tools/ComfyUI/models/controlnet/control_v11p_sd15_openpose.pth  # wget from HuggingFace
  - ~/tools/ComfyUI/models/controlnet/control_v11p_sd15_openpose.yaml  # wget from HuggingFace
  - ~/tools/ComfyUI/custom_nodes/comfyui_controlnet_aux/  # git clone
autonomous: false
requirements:
  - INFRA-02
  - INFRA-05

must_haves:
  truths:
    - "anything-v5-PrtRE.safetensors (~2.1 GB) is present in ~/tools/ComfyUI/models/checkpoints/"
    - "control_v11p_sd15_openpose.pth (1.45 GB) is present in ~/tools/ComfyUI/models/controlnet/"
    - "control_v11p_sd15_openpose.yaml is present in ~/tools/ComfyUI/models/controlnet/"
    - "ComfyUI-ControlNet-Aux is installed and its pip requirements are installed in the ComfyUI venv"
  artifacts:
    - path: "~/tools/ComfyUI/models/checkpoints/anything-v5-PrtRE.safetensors"
      provides: "Primary SD 1.5 checkpoint for benchmark and generation"
      min_lines: 0  # binary file, size check used instead
    - path: "~/tools/ComfyUI/models/controlnet/control_v11p_sd15_openpose.pth"
      provides: "OpenPose ControlNet model (Phase 10)"
    - path: "~/tools/ComfyUI/custom_nodes/comfyui_controlnet_aux/"
      provides: "ComfyUI-ControlNet-Aux extension with OpenPose Estimator node"
  key_links:
    - from: "anything-v5-PrtRE.safetensors"
      to: "ComfyUI Load Checkpoint node"
      via: "~/tools/ComfyUI/models/checkpoints/"
      pattern: "File size >= 2.0 GB"
    - from: "control_v11p_sd15_openpose.pth"
      to: "ControlNet node in ComfyUI"
      via: "~/tools/ComfyUI/models/controlnet/"
      pattern: "File size >= 1.4 GB"
---

<objective>
Download all required model files (Anything V5 checkpoint and OpenPose ControlNet model) and install ComfyUI-ControlNet-Aux. The Anything V5 download requires a human browser action (Civitai authentication); the ControlNet model downloads automatically.

Purpose: Provides the checkpoint for the INFRA-04 benchmark (Plan 04) and installs the ControlNet extension + model required for INFRA-05. Runs after Plan 01 because it writes into ComfyUI directories created there.
Output: Checkpoint, ControlNet model, and extension all present in correct locations.
</objective>

<execution_context>
@/Users/dondemetrius/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dondemetrius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/dondemetrius/Code/plasma/.planning/PROJECT.md
@/Users/dondemetrius/Code/plasma/.planning/ROADMAP.md
@/Users/dondemetrius/Code/plasma/.planning/phases/05-environment-validation/05-RESEARCH.md
</context>

<tasks>

<task type="checkpoint:human-action">
  <name>Task 1: Download Anything V5 from Civitai (requires browser login)</name>
  <files>~/tools/ComfyUI/models/checkpoints/anything-v5-PrtRE.safetensors</files>
  <action>
    Civitai requires an authenticated session for model downloads. Claude cannot automate this — curl/wget returns the login page HTML instead of the binary file. The target directory ~/tools/ComfyUI/models/checkpoints/ already exists from Plan 01.

    Alternative (if you have a Civitai API token): run this instead of browser download:
    ```bash
    curl -L \
      -H "Authorization: Bearer YOUR_CIVITAI_API_TOKEN" \
      "https://civitai.com/api/download/models/9409" \
      -o ~/tools/ComfyUI/models/checkpoints/anything-v5-PrtRE.safetensors
    ```
  </action>
  <verify>
    ```bash
    ls -lh ~/tools/ComfyUI/models/checkpoints/anything-v5-PrtRE.safetensors
    ```
    Expected: file size approximately 2.1G (not KB — KB means the login page HTML was saved instead of the model).
  </verify>
  <done>
    anything-v5-PrtRE.safetensors is present at ~/tools/ComfyUI/models/checkpoints/ with a file size of approximately 2.1 GB.
  </done>
  <what-built>
    Civitai requires an authenticated session for model downloads. Claude cannot automate this — curl/wget returns the login page HTML instead of the binary file. The target directory ~/tools/ComfyUI/models/checkpoints/ already exists from Plan 01.

    Alternative (if you have a Civitai API token): run this instead of browser download:
    ```bash
    curl -L \
      -H "Authorization: Bearer YOUR_CIVITAI_API_TOKEN" \
      "https://civitai.com/api/download/models/9409" \
      -o ~/tools/ComfyUI/models/checkpoints/anything-v5-PrtRE.safetensors
    ```
  </what-built>
  <how-to-verify>
    1. Open your browser and go to: https://civitai.com/models/9409
    2. Log in to your Civitai account if prompted
    3. Click the "Download" button for the file named "anything-v5-PrtRE.safetensors" (the PrtRE variant, ~2.1 GB)
    4. When the download completes, move the file to: ~/tools/ComfyUI/models/checkpoints/anything-v5-PrtRE.safetensors
       (In Finder: the models/checkpoints/ folder is inside ~/tools/ComfyUI/models/checkpoints/)
    5. Verify the file size is approximately 2.1 GB (not a few KB — that would indicate an HTML error page was saved instead of the model)

    Verify the file exists and has the correct size:
    ```bash
    ls -lh ~/tools/ComfyUI/models/checkpoints/anything-v5-PrtRE.safetensors
    ```
    Expected: file size approximately 2.1G
  </how-to-verify>
  <resume-signal>Type "downloaded" once the file is in place and the size check confirms ~2.1 GB</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Download ControlNet OpenPose model and install ControlNet-Aux extension</name>
  <files>
    ~/tools/ComfyUI/models/controlnet/control_v11p_sd15_openpose.pth
    ~/tools/ComfyUI/models/controlnet/control_v11p_sd15_openpose.yaml
    ~/tools/ComfyUI/custom_nodes/comfyui_controlnet_aux/
  </files>
  <action>
    Download the ControlNet OpenPose model from HuggingFace (no authentication required) and install the ComfyUI-ControlNet-Aux extension manually.

    Step 1: Download ControlNet model files
    ```bash
    cd ~/tools/ComfyUI/models/controlnet

    # Download model weights (1.45 GB — use -C - flag to resume if interrupted)
    curl -L -C - \
      "https://huggingface.co/lllyasviel/ControlNet-v1-1/resolve/main/control_v11p_sd15_openpose.pth?download=true" \
      -o control_v11p_sd15_openpose.pth

    # Download config file (required alongside the model)
    curl -L \
      "https://huggingface.co/lllyasviel/ControlNet-v1-1/resolve/main/control_v11p_sd15_openpose.yaml?download=true" \
      -o control_v11p_sd15_openpose.yaml
    ```

    Step 2: Clone ComfyUI-ControlNet-Aux extension
    ```bash
    git clone https://github.com/Fannovel16/comfyui_controlnet_aux.git \
      ~/tools/ComfyUI/custom_nodes/comfyui_controlnet_aux
    ```

    Step 3: Install extension dependencies INSIDE the ComfyUI venv
    IMPORTANT: Must activate the ComfyUI venv (not the kohya venv) for this step.
    ```bash
    source ~/tools/ComfyUI/venv/bin/activate
    cd ~/tools/ComfyUI/custom_nodes/comfyui_controlnet_aux
    pip install -r requirements.txt
    deactivate
    ```
  </action>
  <verify>
    ```bash
    # Verify ControlNet model file size (must be ~1.45 GB, not KB)
    ls -lh ~/tools/ComfyUI/models/controlnet/control_v11p_sd15_openpose.pth
    ls -lh ~/tools/ComfyUI/models/controlnet/control_v11p_sd15_openpose.yaml

    # Verify extension is cloned
    ls ~/tools/ComfyUI/custom_nodes/comfyui_controlnet_aux/__init__.py

    # Verify extension requirements installed in ComfyUI venv
    source ~/tools/ComfyUI/venv/bin/activate
    python -c "import cv2; print('opencv OK')"
    deactivate
    ```
    Expected: .pth file >= 1.4G, .yaml file exists, __init__.py exists, opencv imports without error.

    If .pth size is < 100 MB, the download failed or was truncated — re-run the curl command with `-C -` to resume.
  </verify>
  <done>
    control_v11p_sd15_openpose.pth is present at ~1.45 GB, the .yaml config file exists alongside it, comfyui_controlnet_aux is cloned and its requirements are installed in the ComfyUI venv.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `ls -lh ~/tools/ComfyUI/models/checkpoints/anything-v5-PrtRE.safetensors` — ~2.1G
2. `ls -lh ~/tools/ComfyUI/models/controlnet/control_v11p_sd15_openpose.pth` — ~1.45G
3. `ls ~/tools/ComfyUI/models/controlnet/control_v11p_sd15_openpose.yaml` — exists
4. `ls ~/tools/ComfyUI/custom_nodes/comfyui_controlnet_aux/__init__.py` — exists
</verification>

<success_criteria>
All model files are present at correct paths and correct sizes. ControlNet-Aux extension is cloned and its pip dependencies are installed in the ComfyUI venv.
</success_criteria>

<output>
After completion, create `/Users/dondemetrius/Code/plasma/.planning/phases/05-environment-validation/05-03-SUMMARY.md`
</output>
