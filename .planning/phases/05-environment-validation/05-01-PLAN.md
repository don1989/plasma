---
phase: 05-environment-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/tools/ComfyUI/  # git clone (new directory)
  - ~/tools/ComfyUI/venv/  # Python 3.11.9 venv
  - ~/tools/ComfyUI/custom_nodes/ComfyUI-Manager/  # git clone
autonomous: true
requirements:
  - INFRA-01

must_haves:
  truths:
    - "ComfyUI is cloned at ~/tools/ComfyUI with a Python 3.11.9 venv"
    - "PyTorch 2.5.1 is installed in the ComfyUI venv with MPS available (torch.backends.mps.is_available() returns True)"
    - "ComfyUI-Manager is cloned into ~/tools/ComfyUI/custom_nodes/ComfyUI-Manager"
    - "MPS verification script prints 'MPS available: True' and creates a tensor on mps:0"
  artifacts:
    - path: "~/tools/ComfyUI/main.py"
      provides: "ComfyUI entrypoint"
    - path: "~/tools/ComfyUI/venv/bin/python"
      provides: "Isolated Python 3.11.9 environment"
    - path: "~/tools/ComfyUI/custom_nodes/ComfyUI-Manager/"
      provides: "Custom node manager extension"
  key_links:
    - from: "ComfyUI venv"
      to: "PyTorch MPS backend"
      via: "torch.backends.mps.is_available()"
      pattern: "MPS available: True"
---

<objective>
Install ComfyUI with its Python 3.11.9 virtual environment and PyTorch 2.5.1 (MPS-enabled), verify Metal acceleration is active, and pre-install ComfyUI-Manager before the first launch.

Purpose: Establishes the SD inference server that all downstream phases depend on. MPS verification here gates the benchmark in Plan 04.
Output: ~/tools/ComfyUI/ with working venv, PyTorch MPS confirmed, ComfyUI-Manager in custom_nodes/.
</objective>

<execution_context>
@/Users/dondemetrius/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dondemetrius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/dondemetrius/Code/plasma/.planning/PROJECT.md
@/Users/dondemetrius/Code/plasma/.planning/ROADMAP.md
@/Users/dondemetrius/Code/plasma/.planning/STATE.md
@/Users/dondemetrius/Code/plasma/.planning/phases/05-environment-validation/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clone ComfyUI, create venv, install PyTorch 2.5.1 with MPS</name>
  <files>~/tools/ComfyUI/</files>
  <action>
    Run the following commands in sequence. Do NOT use a CUDA wheel — the "cpu" index URL contains the arm64 MPS-enabled wheel.

    ```bash
    # Create tools directory (no-op if already exists)
    mkdir -p ~/tools

    # Clone ComfyUI
    git clone https://github.com/comfyanonymous/ComfyUI.git ~/tools/ComfyUI

    # Enter directory and create isolated Python 3.11.9 venv
    cd ~/tools/ComfyUI
    python3.11 -m venv venv
    source venv/bin/activate

    # Install PyTorch 2.5.1 for Apple Silicon
    # "cpu" index URL is correct — it contains the arm64/MPS wheel, NOT CUDA wheels
    pip install torch==2.5.1 torchvision==0.20.1 \
      --index-url https://download.pytorch.org/whl/cpu

    # Install ComfyUI runtime dependencies
    pip install -r requirements.txt

    deactivate
    ```

    Do NOT install bitsandbytes, xformers, or triton — these are CUDA/Linux-only and will fail on arm64.
    Do NOT use any cu118/cu121/cu124 index URL — those are CUDA wheels.
  </action>
  <verify>
    ```bash
    source ~/tools/ComfyUI/venv/bin/activate
    python -c "
    import torch
    print('PyTorch version:', torch.__version__)
    print('MPS available:', torch.backends.mps.is_available())
    print('MPS built:', torch.backends.mps.is_built())
    t = torch.ones(1, device='mps')
    print('MPS tensor test:', t)
    "
    deactivate
    ```
    Expected output:
    ```
    PyTorch version: 2.5.1
    MPS available: True
    MPS built: True
    MPS tensor test: tensor([1.], device='mps:0')
    ```
    If "MPS available: False" — the wrong PyTorch wheel was installed (CUDA wheel instead of arm64). Re-run pip install with the cpu index URL.
  </verify>
  <done>
    ~/tools/ComfyUI/main.py exists, venv activates without error, and the MPS verification script prints "MPS available: True" with a tensor on mps:0.
  </done>
</task>

<task type="auto">
  <name>Task 2: Clone ComfyUI-Manager into custom_nodes</name>
  <files>~/tools/ComfyUI/custom_nodes/ComfyUI-Manager/</files>
  <action>
    Clone ComfyUI-Manager before the first ComfyUI launch. This must happen before launch — Manager is detected at startup, not dynamically.

    ```bash
    git clone https://github.com/ltdrdata/ComfyUI-Manager.git \
      ~/tools/ComfyUI/custom_nodes/ComfyUI-Manager
    ```

    No pip install is needed for Manager itself — it runs as a ComfyUI extension loaded at startup.

    Also create the controlnet model directory so Plan 03 can drop files directly:
    ```bash
    mkdir -p ~/tools/ComfyUI/models/controlnet
    ```
  </action>
  <verify>
    ```bash
    ls ~/tools/ComfyUI/custom_nodes/ComfyUI-Manager/__init__.py
    ls -d ~/tools/ComfyUI/models/controlnet/
    ```
    Both paths must exist without "No such file" errors.
  </verify>
  <done>
    ~/tools/ComfyUI/custom_nodes/ComfyUI-Manager/__init__.py exists and ~/tools/ComfyUI/models/controlnet/ directory is present.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `ls ~/tools/ComfyUI/main.py` — exists
2. `ls ~/tools/ComfyUI/venv/bin/python` — exists
3. MPS verification passes (see Task 1 verify)
4. `ls ~/tools/ComfyUI/custom_nodes/ComfyUI-Manager/__init__.py` — exists
5. `ls -d ~/tools/ComfyUI/models/controlnet/` — exists
</verification>

<success_criteria>
ComfyUI is installed at ~/tools/ComfyUI with an isolated Python 3.11.9 venv, PyTorch 2.5.1 MPS-enabled (confirmed by tensor test on mps:0), and ComfyUI-Manager is in custom_nodes/ ready for first launch.
</success_criteria>

<output>
After completion, create `/Users/dondemetrius/Code/plasma/.planning/phases/05-environment-validation/05-01-SUMMARY.md`
</output>
