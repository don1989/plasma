---
phase: 05-environment-validation
plan: 04
type: execute
wave: 3
depends_on:
  - "05-01"
  - "05-02"
  - "05-03"
files_modified:
  - /Users/dondemetrius/Code/plasma/.planning/phases/05-environment-validation/05-BENCHMARK.md  # benchmark results
autonomous: false
requirements:
  - INFRA-04
  - INFRA-01

must_haves:
  truths:
    - "ComfyUI server starts and is reachable at http://127.0.0.1:8188/system_stats with devices[0].type == 'mps'"
    - "A 512x512, 20-step Euler a generation using Anything V5 completes in under 2 minutes"
    - "Activity Monitor GPU History shows non-zero GPU utilization during generation (MPS is active, not CPU fallback)"
    - "Benchmark results are recorded in 05-BENCHMARK.md with actual elapsed time"
  artifacts:
    - path: "/Users/dondemetrius/Code/plasma/.planning/phases/05-environment-validation/05-BENCHMARK.md"
      provides: "Benchmark results — actual generation time, MPS confirmation, system_stats JSON"
  key_links:
    - from: "ComfyUI server"
      to: "http://127.0.0.1:8188/system_stats"
      via: "curl"
      pattern: "\"type\": \"mps\""
    - from: "Generation timer"
      to: "05-BENCHMARK.md"
      via: "human observation + record"
      pattern: "elapsed_seconds < 120"
---

<objective>
Launch ComfyUI with MPS flags, verify it is reachable via /system_stats (confirming MPS device), run the INFRA-04 hardware benchmark (512x512, 20 steps, Euler a, Anything V5, under 2 minutes), and record results.

Purpose: This is the phase gate. Every downstream phase (7, 10) depends on ComfyUI being confirmed working with MPS. The benchmark result provides a concrete baseline for Phase 7 integration timing expectations.
Output: 05-BENCHMARK.md with actual timing, system_stats confirmation, and pass/fail verdict.
</objective>

<execution_context>
@/Users/dondemetrius/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dondemetrius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/dondemetrius/Code/plasma/.planning/PROJECT.md
@/Users/dondemetrius/Code/plasma/.planning/ROADMAP.md
@/Users/dondemetrius/Code/plasma/.planning/phases/05-environment-validation/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Launch ComfyUI and verify /system_stats confirms MPS</name>
  <files>/Users/dondemetrius/Code/plasma/.planning/phases/05-environment-validation/05-BENCHMARK.md</files>
  <action>
    Launch ComfyUI in a background process and verify the /system_stats endpoint returns JSON with MPS device. Create the benchmark results file.

    IMPORTANT: Use PYTORCH_ENABLE_MPS_FALLBACK=1 — without it, any MPS op not supported by PyTorch will crash instead of falling back to CPU.
    IMPORTANT: Use --force-fp16 — halves memory usage, required for 16GB unified memory to avoid OOM during generation.
    NOTE: Use --listen 127.0.0.1, NOT --listen 0.0.0.0 — only accept localhost connections.

    ```bash
    # Launch ComfyUI in background (user will monitor in separate terminal if needed)
    source ~/tools/ComfyUI/venv/bin/activate
    cd ~/tools/ComfyUI
    PYTORCH_ENABLE_MPS_FALLBACK=1 python main.py \
      --force-fp16 \
      --listen 127.0.0.1 \
      --port 8188 &
    COMFYUI_PID=$!
    echo "ComfyUI PID: $COMFYUI_PID"

    # Wait for startup (ComfyUI takes 15-30 seconds to load models)
    sleep 30

    # Health check via /system_stats (NOT /health — that endpoint doesn't exist in ComfyUI)
    STATS=$(curl -s http://127.0.0.1:8188/system_stats)
    echo "$STATS" | python3 -m json.tool
    ```

    Verify the response contains `"type": "mps"` in the devices array. If it contains `"type": "cpu"` only — MPS was not detected. If curl fails with "Connection refused" — ComfyUI hasn't finished starting yet, wait longer and retry.

    Create the benchmark results stub file using the Write tool (not a heredoc — use the Write tool directly to avoid shell quoting issues):

    Write the following content to /Users/dondemetrius/Code/plasma/.planning/phases/05-environment-validation/05-BENCHMARK.md:

    ```
    # Phase 5 Benchmark Results

    **Date:** 2026-02-19
    **Machine:** M1 Pro, macOS 25.2 arm64, 16GB unified memory
    **ComfyUI launch flags:** --force-fp16 --listen 127.0.0.1 --port 8188

    ## System Stats (from /system_stats)

    PASTE_SYSTEM_STATS_JSON_HERE

    ## MPS Confirmation

    - devices[0].type: FILL_IN (expected: "mps")
    - python_version: FILL_IN (expected: "3.11.x")

    ## INFRA-04 Benchmark

    **Parameters:**
    - Checkpoint: anything-v5-PrtRE.safetensors
    - Resolution: 512 x 512
    - Steps: 20
    - Sampler: euler_ancestral (Euler a)
    - Scheduler: normal
    - CFG Scale: 7.0
    - Prompt: anime character, white cloak, standing, masterpiece

    **Results:**
    - Start time: FILL_IN
    - End time: FILL_IN
    - Elapsed seconds: FILL_IN
    - GPU History (Activity Monitor): FILL_IN (active / flat / unknown)

    ## Verdict

    - INFRA-04 benchmark (< 120 seconds): PASS / FAIL
    - MPS active (/system_stats devices[0].type == "mps"): PASS / FAIL
    - Phase 5 gate: PASS / FAIL
    ```
  </action>
  <verify>
    ```bash
    curl -s http://127.0.0.1:8188/system_stats | python3 -c "
    import json, sys
    data = json.load(sys.stdin)
    devices = data.get('devices', [])
    if not devices:
        print('FAIL: no devices in response')
        sys.exit(1)
    device_types = [d.get('type') for d in devices]
    if 'mps' in device_types:
        print('PASS: MPS device found:', device_types)
    else:
        print('FAIL: MPS not found, devices:', device_types)
        sys.exit(1)
    "
    ```
    Expected: `PASS: MPS device found: ['mps']`

    If FAIL: PyTorch may not have detected MPS. Check that venv is active and PyTorch was installed from the cpu index URL.
  </verify>
  <done>
    ComfyUI is running at http://127.0.0.1:8188, /system_stats returns JSON with devices[0].type == "mps", and 05-BENCHMARK.md stub is created with placeholder fields.
  </done>
</task>

<task type="checkpoint:human-verify">
  <name>Task 2: Run INFRA-04 benchmark in browser and record results</name>
  <files>/Users/dondemetrius/Code/plasma/.planning/phases/05-environment-validation/05-BENCHMARK.md</files>
  <action>
    ComfyUI is running at http://127.0.0.1:8188 with MPS confirmed via /system_stats (Task 1). The benchmark requires manual interaction in the ComfyUI browser UI — Claude cannot submit generation jobs through the browser UI directly. The user runs the generation and records the result back into 05-BENCHMARK.md.
  </action>
  <verify>
    Confirm 05-BENCHMARK.md has been updated with:
    - Actual system_stats JSON (not placeholder)
    - Actual elapsed seconds (not FILL_IN)
    - GPU History observation ("active" or "flat")
    - PASS/FAIL verdict for INFRA-04
  </verify>
  <done>
    05-BENCHMARK.md contains actual benchmark results. INFRA-04 verdict is PASS (elapsed seconds < 120). GPU History shows "active" (Metal acceleration confirmed).
  </done>
  <what-built>
    ComfyUI is running at http://127.0.0.1:8188 with MPS confirmed via /system_stats. The benchmark requires manual interaction in the ComfyUI browser UI — Claude cannot automate image generation through the browser UI.
  </what-built>
  <how-to-verify>
    1. Open http://127.0.0.1:8188 in your browser. You should see the ComfyUI node graph editor.

    2. Open Activity Monitor (Spotlight: "Activity Monitor"), go to Window menu → GPU History. Keep this visible during generation to confirm Metal is active.

    3. In the ComfyUI browser UI, configure the default workflow:
       - "Load Checkpoint" node: select "anything-v5-PrtRE.safetensors"
       - "KSampler" node: set sampler_name to "euler_ancestral", scheduler to "normal", steps to 20, cfg to 7.0
       - "Empty Latent Image" node: set width to 512, height to 512

    4. In the CLIP Text Encode (positive prompt) node, enter:
       `anime character, white cloak, standing, masterpiece`

    5. Start a timer (phone or terminal: `date`), then click "Queue Prompt"

    6. Watch Activity Monitor GPU History — the GPU utilization bar MUST show non-zero activity during generation. If the GPU bar stays completely flat for more than 30 seconds after queuing, generation is falling back to CPU (will take 10+ minutes) — STOP and investigate MPS detection.

    7. When the image appears in the output area, stop the timer and note the elapsed time.

    8. Edit /Users/dondemetrius/Code/plasma/.planning/phases/05-environment-validation/05-BENCHMARK.md:
       - Replace PASTE_SYSTEM_STATS_JSON_HERE with the actual JSON from:
         `curl -s http://127.0.0.1:8188/system_stats`
       - Fill in start time, end time, elapsed seconds
       - Fill in GPU History observation ("active" if GPU bar showed utilization, "flat" if it did not)
       - Set the PASS/FAIL verdict lines

    Target: under 120 seconds (2 minutes). M1 Pro community reports: typically 30-90 seconds.

    9. After recording results, stop ComfyUI:
       ```bash
       kill $(lsof -ti:8188) 2>/dev/null || echo "ComfyUI already stopped"
       ```
  </how-to-verify>
  <resume-signal>
    Type "benchmark-complete: Xs" where X is the elapsed seconds (e.g., "benchmark-complete: 47s"), or "benchmark-failed: [reason]" if the generation failed or exceeded 2 minutes.
  </resume-signal>
</task>

</tasks>

<verification>
Phase 5 is complete when:
1. /system_stats returned "type": "mps" in devices array
2. Benchmark elapsed time < 120 seconds
3. GPU History showed non-zero utilization (MPS active, not CPU fallback)
4. 05-BENCHMARK.md is filled in with actual results and all verdicts show PASS
5. All 5 success criteria from ROADMAP.md are TRUE:
   - INFRA-01: ComfyUI running with MPS at http://127.0.0.1:8188 (confirmed by /system_stats)
   - INFRA-02: anything-v5-PrtRE.safetensors in ~/tools/ComfyUI/models/checkpoints/ (Plan 03)
   - INFRA-03: kohya_ss venv with mixed_precision: no (Plan 02)
   - INFRA-04: 512x512, 20-step benchmark under 2 minutes (this plan)
   - INFRA-05: ComfyUI-Manager + ControlNet-Aux installed, OpenPose model present (Plan 03)
</verification>

<success_criteria>
ComfyUI serves valid JSON at /system_stats with devices[0].type == "mps". A 512x512, 20-step Euler a generation using Anything V5 completes in under 120 seconds. GPU History confirms Metal acceleration was active. Benchmark results recorded in 05-BENCHMARK.md. Phase 5 is unblocked — Phases 7 and 10 may now be planned.
</success_criteria>

<output>
After completion, create `/Users/dondemetrius/Code/plasma/.planning/phases/05-environment-validation/05-04-SUMMARY.md`
</output>
