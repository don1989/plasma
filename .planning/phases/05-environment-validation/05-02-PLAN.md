---
phase: 05-environment-validation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/tools/kohya_ss/  # git clone (new directory)
  - ~/tools/kohya_ss/venv/  # Python 3.11.9 venv
  - ~/.cache/huggingface/accelerate/default_config.yaml
autonomous: true
requirements:
  - INFRA-03

must_haves:
  truths:
    - "kohya_ss is cloned at ~/tools/kohya_ss with a separate Python 3.11.9 venv"
    - "accelerate 1.3.0 is installed in the kohya venv alongside torch==2.5.1"
    - "accelerate env reports mixed_precision: no and device: mps"
    - "The Accelerator() smoke test prints device: mps"
  artifacts:
    - path: "~/tools/kohya_ss/venv/bin/python"
      provides: "Isolated kohya_ss Python environment (separate from ComfyUI venv)"
    - path: "~/.cache/huggingface/accelerate/default_config.yaml"
      provides: "accelerate config — mixed_precision: no, compute_environment: LOCAL_MACHINE"
  key_links:
    - from: "accelerate config"
      to: "MPS device"
      via: "Accelerator() smoke test"
      pattern: "device: mps"
    - from: "kohya venv"
      to: "torch.backends.mps"
      via: "PYTORCH_ENABLE_MPS_FALLBACK=1"
      pattern: "MPS available: True"
---

<objective>
Install kohya_ss in a separate Python 3.11.9 venv with manually-curated dependencies (bypassing the broken requirements_macos_arm64.txt), and configure accelerate for MPS with mixed_precision: no.

Purpose: kohya_ss is the LoRA training toolkit for Phase 8. The environment must be validated before any training is attempted. This plan runs fully in parallel with Plan 01 since it touches completely different directories.
Output: ~/tools/kohya_ss/ with working venv, accelerate configured, MPS smoke test passing.
</objective>

<execution_context>
@/Users/dondemetrius/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dondemetrius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/dondemetrius/Code/plasma/.planning/PROJECT.md
@/Users/dondemetrius/Code/plasma/.planning/ROADMAP.md
@/Users/dondemetrius/Code/plasma/.planning/STATE.md
@/Users/dondemetrius/Code/plasma/.planning/phases/05-environment-validation/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clone kohya_ss and install dependencies via manual pip (NOT requirements_macos_arm64.txt)</name>
  <files>~/tools/kohya_ss/</files>
  <action>
    CRITICAL: Do NOT run `pip install -r requirements_macos_arm64.txt`. This file references `torch==2.8.0.*` which is a nightly-only version that does not exist as a stable release (GitHub issue #3281, confirmed broken as of 2026-02-19). Use the manual pip install below.

    ```bash
    mkdir -p ~/tools

    # Clone kohya_ss
    git clone https://github.com/bmaltais/kohya_ss.git ~/tools/kohya_ss
    cd ~/tools/kohya_ss

    # Create SEPARATE venv — must NOT share with ComfyUI venv
    python3.11 -m venv venv
    source venv/bin/activate

    # Install PyTorch 2.5.1 for Apple Silicon
    # "cpu" index URL is correct for arm64 MPS — same pin as ComfyUI
    pip install torch==2.5.1 torchvision==0.20.1 \
      --index-url https://download.pytorch.org/whl/cpu

    # Install training dependencies — curated for Apple Silicon
    # Explicitly omitting: bitsandbytes (CUDA), xformers (CUDA/NVIDIA), triton (Linux/CUDA)
    pip install \
      accelerate==1.3.0 \
      transformers==4.48.1 \
      diffusers==0.32.2 \
      safetensors \
      lycoris-lora \
      toml \
      voluptuous \
      tensorboard \
      Pillow \
      opencv-python \
      einops \
      ftfy \
      tqdm \
      pyyaml \
      huggingface_hub

    deactivate
    ```

    Do NOT install bitsandbytes, xformers, or triton. These are CUDA/Linux-only and will fail or cause silent failures on Apple Silicon.
  </action>
  <verify>
    ```bash
    source ~/tools/kohya_ss/venv/bin/activate
    python -c "
    import torch
    import accelerate
    print('PyTorch:', torch.__version__)
    print('accelerate:', accelerate.__version__)
    print('MPS available:', torch.backends.mps.is_available())
    "
    deactivate
    ```
    Expected:
    ```
    PyTorch: 2.5.1
    accelerate: 1.3.0
    MPS available: True
    ```
  </verify>
  <done>
    ~/tools/kohya_ss/venv activates without error, torch 2.5.1 and accelerate 1.3.0 are importable, and MPS shows True.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure accelerate for MPS with mixed_precision: no</name>
  <files>~/.cache/huggingface/accelerate/default_config.yaml</files>
  <action>
    Use the Python shortcut to write the accelerate config programmatically (avoids interactive prompts that Claude cannot answer).

    CRITICAL: mixed_precision MUST be 'no' — NOT 'fp16', NOT 'bf16'. Setting fp16 triggers:
    `ValueError: fp16 mixed precision requires a GPU (not 'mps')`
    PyTorch's AMP autocast framework does not support mps + fp16 mixed precision training.

    ```bash
    source ~/tools/kohya_ss/venv/bin/activate

    python -c "
    from accelerate.utils import write_basic_config
    write_basic_config(mixed_precision='no')
    print('accelerate config written')
    "

    # Verify the config was written correctly
    cat ~/.cache/huggingface/accelerate/default_config.yaml

    deactivate
    ```

    The written config should contain:
    ```yaml
    compute_environment: LOCAL_MACHINE
    mixed_precision: 'no'
    use_cpu: false
    ```

    Then run the MPS smoke test to confirm Accelerator picks up MPS:
    ```bash
    source ~/tools/kohya_ss/venv/bin/activate
    export PYTORCH_ENABLE_MPS_FALLBACK=1

    python -c "
    import torch
    from accelerate import Accelerator
    a = Accelerator()
    print('Device:', a.device)
    print('Mixed precision:', a.mixed_precision)
    "
    deactivate
    ```
    Expected output:
    ```
    Device: mps
    Mixed precision: no
    ```
  </action>
  <verify>
    ```bash
    source ~/tools/kohya_ss/venv/bin/activate
    accelerate env
    deactivate
    ```
    The output must contain:
    - `compute_environment: LOCAL_MACHINE`
    - `mixed_precision: no`
    - `use_cpu: False`

    Also verify the config file:
    ```bash
    grep "mixed_precision" ~/.cache/huggingface/accelerate/default_config.yaml
    ```
    Must show `mixed_precision: 'no'` — any other value (fp16, bf16) is a failure.
  </verify>
  <done>
    ~/.cache/huggingface/accelerate/default_config.yaml exists with mixed_precision: 'no', and the Accelerator() smoke test prints "Device: mps" and "Mixed precision: no".
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `ls ~/tools/kohya_ss/venv/bin/python` — exists
2. MPS + version check passes (see Task 1 verify)
3. `grep mixed_precision ~/.cache/huggingface/accelerate/default_config.yaml` — shows 'no'
4. Accelerator() smoke test prints "Device: mps"
</verification>

<success_criteria>
kohya_ss is installed at ~/tools/kohya_ss with Python 3.11.9 venv and manually-curated dependencies (no bitsandbytes/xformers/triton). accelerate is configured with mixed_precision: no. The Accelerator() smoke test confirms MPS device is selected.
</success_criteria>

<output>
After completion, create `/Users/dondemetrius/Code/plasma/.planning/phases/05-environment-validation/05-02-SUMMARY.md`
</output>
