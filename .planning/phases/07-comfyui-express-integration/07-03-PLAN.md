---
phase: 07-comfyui-express-integration
plan: "03"
type: execute
wave: 3
depends_on:
  - "07-01"
  - "07-02"
files_modified:
  - pipeline/src/cli.ts
  - pipeline/src/stages/generate.ts
  - pipeline/src/types/generation.ts
  - pipeline/src/config/paths.ts
  - pipeline/src/generation/image-import.ts
autonomous: false
requirements:
  - PIPE-01
  - PIPE-02
  - PIPE-03

must_haves:
  truths:
    - "`pnpm stage:generate -- --comfyui -c 1 --page 1` submits to Express service and produces an image in output/ch-01/raw/ with naming ch01_p001_v1.png"
    - "Running generate without --comfyui or --gemini (or --manual/--api) fails with a clear error message requiring explicit flag"
    - "Existing --manual and --api (Gemini) modes still work unchanged"
    - "Approving a ComfyUI image copies it from raw/comfyui/ to raw/ so overlay/assemble can find it"
    - "Overlay stage runs on an approved ComfyUI image without modification to overlay code"
  artifacts:
    - path: "pipeline/src/cli.ts"
      provides: "Updated generate command with --comfyui flag and no-default error"
      contains: "--comfyui"
    - path: "pipeline/src/stages/generate.ts"
      provides: "ComfyUI mode branch + approve-and-copy promotion"
      contains: "mode === 'comfyui'"
    - path: "pipeline/src/types/generation.ts"
      provides: "GenerationLogEntry extended with source field"
      contains: "source"
    - path: "pipeline/src/config/paths.ts"
      provides: "comfyuiRaw subpath helper"
      contains: "comfyui"
  key_links:
    - from: "pipeline/src/cli.ts"
      to: "pipeline/src/stages/generate.ts"
      via: "mode: 'comfyui' passed in options"
      pattern: "mode.*comfyui"
    - from: "pipeline/src/stages/generate.ts"
      to: "http://127.0.0.1:3000"
      via: "fetch /health then POST /jobs"
      pattern: "fetch.*3000"
    - from: "pipeline/src/stages/generate.ts"
      to: "output/ch-01/raw/"
      via: "approve-and-copy from raw/comfyui/"
      pattern: "copyFile.*comfyui"
---

<objective>
Wire the Express service into the existing pipeline CLI and generate stage. Add `--comfyui` flag to `cli.ts`, implement the `mode === 'comfyui'` branch in `generate.ts`, and update the approval flow to copy ComfyUI images from `raw/comfyui/` to `raw/` so overlay/assemble stages consume them unchanged.

Purpose: Completes the end-to-end loop — `pnpm stage:generate -- --comfyui -c 1 --page 1` becomes a working command. The Gemini path remains intact. No changes to overlay or assemble.
Output: Updated cli.ts, generate.ts, types/generation.ts, paths.ts. Full end-to-end test passes.
</objective>

<execution_context>
@/Users/dondemetrius/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dondemetrius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/07-comfyui-express-integration/07-CONTEXT.md
@.planning/phases/07-comfyui-express-integration/07-RESEARCH.md
@.planning/phases/07-comfyui-express-integration/07-01-SUMMARY.md
@.planning/phases/07-comfyui-express-integration/07-02-SUMMARY.md
@pipeline/src/cli.ts
@pipeline/src/stages/generate.ts
@pipeline/src/types/generation.ts
@pipeline/src/config/paths.ts
@pipeline/src/generation/manifest.ts
@pipeline/src/generation/naming.ts
@pipeline/src/generation/image-import.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update types, paths, and CLI flag</name>
  <files>
    pipeline/src/types/generation.ts
    pipeline/src/config/paths.ts
    pipeline/src/cli.ts
  </files>
  <action>
**Update `pipeline/src/types/generation.ts`:**

Extend `GenerationLogEntry` with two optional fields needed for the approve-and-copy flow:
```typescript
export interface GenerationLogEntry {
  // ... existing fields unchanged ...
  /** Generation source — 'gemini' (manual/api) or 'comfyui'. Absent for legacy entries. */
  source?: 'gemini' | 'comfyui';
  /** For comfyui-sourced images: absolute path to source file in raw/comfyui/ before promotion. */
  sourcePath?: string;
}
```

**Update `pipeline/src/config/paths.ts`:**

Add `comfyuiRaw` to the `chapterOutput` return object:
```typescript
chapterOutput: (chapter: number) => {
  const chNum = String(chapter).padStart(2, '0');
  const root = path.join(PROJECT_ROOT, 'output', `ch-${chNum}`);
  const raw = path.join(root, 'raw');
  return {
    root,
    raw,
    processed: path.join(root, 'processed'),
    lettered: path.join(root, 'lettered'),
    webtoon: path.join(root, 'webtoon'),
    prompts: path.join(root, 'prompts'),
    comfyuiRaw: path.join(raw, 'comfyui'),  // NEW: raw/comfyui/ for ComfyUI-generated images
  };
},
```

**Update `pipeline/src/cli.ts` — `generate` command:**

1. Add `--comfyui` option to the generate command definition (after existing `--api` option):
   ```typescript
   .option('--comfyui', 'Automated workflow: call ComfyUI via Express service')
   ```

2. Replace the mode determination block (currently line 104-105):
   ```typescript
   // OLD:
   const mode: 'manual' | 'api' = options.api ? 'api' : 'manual';

   // NEW (per user decision — no default, require explicit flag):
   if (!options.manual && !options.api && !options.comfyui && !options.import && !options.approve) {
     console.error('Error: specify --comfyui, --gemini (--api), or --manual explicitly');
     process.exit(1);
   }
   const mode: 'manual' | 'api' | 'comfyui' = options.comfyui ? 'comfyui' : options.api ? 'api' : 'manual';
   ```
   Note: The error guard must NOT fire when `--import` or `--approve` are present (those are valid mode-independent operations).

3. Pass `mode` to `runGenerate` — it's already being passed as `mode` in the options object. The type change (`'comfyui'` added) flows through.

4. For `--comfyui` mode, `--page` is required. Add validation after the import/reference validations:
   ```typescript
   if (options.comfyui && !options.page) {
     console.error('Error: --comfyui requires --page. Specify which page to generate.');
     process.exit(1);
   }
   ```

Keep the `--gemini` alias in the description text so users know `--api` is the Gemini flag. No new `--gemini` option needed — `--api` remains the Gemini flag per existing code.
  </action>
  <verify>
```
cd /Users/dondemetrius/Code/plasma/pipeline && pnpm typecheck
```
Run:
```
pnpm stage:generate -- -c 1
```
Expect: error message "specify --comfyui, --gemini (--api), or --manual explicitly" and exit 1.
Run:
```
pnpm stage:generate -- --comfyui -c 1
```
Expect: error message "--comfyui requires --page" and exit 1.
  </verify>
  <done>
`pnpm typecheck` passes. CLI rejects no-mode invocations with clear error. `--comfyui` without `--page` errors with clear message. Existing `--manual` and `--api` flags still work.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement ComfyUI mode branch and approve-and-copy in generate.ts</name>
  <files>
    pipeline/src/stages/generate.ts
  </files>
  <action>
Update `pipeline/src/stages/generate.ts` with the following changes:

**1. Update `GenerateOptions` interface:**
```typescript
export interface GenerateOptions extends StageOptions {
  /** Workflow mode: manual (copy-paste), api (Gemini), or comfyui. No default — must be explicit. */
  mode?: 'manual' | 'api' | 'comfyui';
  // ... rest unchanged ...
}
```

**2. Add `checkServiceRunning` helper function** (before `runGenerate`):
```typescript
async function checkServiceRunning(port: number = 3000): Promise<void> {
  try {
    const res = await fetch(`http://127.0.0.1:${port}/health`, {
      signal: AbortSignal.timeout(2000),
    });
    if (!res.ok) {
      throw new Error(`Service returned ${res.status}`);
    }
  } catch {
    throw new Error(
      `Express service not running at port ${port} — run \`pnpm start:service\` first`
    );
  }
}
```

**3. Update the fallback error at the bottom of `runGenerate`:**
```typescript
// OLD:
errors: ['Unknown generate mode. Use --manual or --api.'],

// NEW:
errors: ['Unknown generate mode. Use --comfyui, --api, or --manual.'],
```

**4. Update the approve flow** to handle ComfyUI-sourced images. The existing `approveImage` in `generation/image-import.ts` sets `approved: true` in the manifest. We need to also copy the file from `raw/comfyui/` to `raw/` if `source === 'comfyui'`.

Update the approve block inside `runGenerate`:
```typescript
if (options.approve) {
  try {
    await approveImage({
      imageFile: options.approve,
      chapterDir: chapterPaths.root,
    });

    // Approve-and-copy for ComfyUI-sourced images (PIPE-03)
    // Load manifest to check source
    const manifest = await loadManifest(chapterPaths.root, options.chapter);
    const entry = manifest.entries.find(e => e.imageFile === options.approve);
    if (entry?.source === 'comfyui' && entry.sourcePath) {
      const { copyFile } = await import('node:fs/promises');
      const destPath = path.join(chapterPaths.raw, options.approve);
      await copyFile(entry.sourcePath, destPath);
      console.log(`[generate] Promoted ComfyUI image: ${options.approve} -> raw/`);
    }

    console.log(`[generate] Approved: ${options.approve}`);
    // ... rest of approve block unchanged ...
  }
}
```

**5. Add the ComfyUI mode branch** after the API mode block (before the fallback return), inside `runGenerate`:

```typescript
// --- ComfyUI mode (via Express service) ---
if (mode === 'comfyui') {
  const page = options.page;
  if (page == null) {
    return {
      stage: 'generate',
      success: false,
      outputFiles: [],
      errors: ['ComfyUI mode requires --page option.'],
      duration: Date.now() - startTime,
    };
  }

  // 1. Fail fast if service not running (CONTEXT.md: fail immediately with clear error)
  try {
    await checkServiceRunning();
  } catch (error) {
    const msg = error instanceof Error ? error.message : String(error);
    return {
      stage: 'generate',
      success: false,
      outputFiles: [],
      errors: [msg],
      duration: Date.now() - startTime,
    };
  }

  // 2. Read prompt file (CONTEXT.md: reuse existing prompt stage output)
  const promptsDir = chapterPaths.prompts;
  const promptFilename = `page-${String(page).padStart(2, '0')}.txt`;
  const promptFilePath = path.join(promptsDir, promptFilename);
  if (!existsSync(promptFilePath)) {
    return {
      stage: 'generate',
      success: false,
      outputFiles: [],
      errors: [`Prompt file not found: ${promptFilePath}. Run the prompt stage first.`],
      duration: Date.now() - startTime,
    };
  }
  const promptText = await readFile(promptFilePath, 'utf-8');

  // 3. Ensure comfyui subdir exists
  const comfyuiDir = chapterPaths.comfyuiRaw;
  await ensureDir(comfyuiDir);

  // 4. Determine version
  const version = nextVersion(comfyuiDir, options.chapter, page);
  const imageFile = panelImageFilename(options.chapter, page, version);

  console.log(`[generate] ComfyUI mode -- Chapter ${options.chapter}, Page ${page}, Version ${version}`);

  // 5. Submit job to Express service (POST /jobs)
  let jobId: string;
  try {
    const jobRes = await fetch('http://127.0.0.1:3000/jobs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        prompt_text: promptText,
        resolution: { width: 512, height: 768 },
        chapter: options.chapter,
        page,
        seed: Math.floor(Math.random() * 2_147_483_647),
      }),
    });
    if (!jobRes.ok) {
      const errBody = await jobRes.json() as { error: string };
      throw new Error(`POST /jobs failed: ${jobRes.status} — ${errBody.error}`);
    }
    const { jobId: id } = await jobRes.json() as { jobId: string };
    jobId = id;
    console.log(`[generate] Job submitted: ${jobId}`);
  } catch (error) {
    const msg = error instanceof Error ? error.message : String(error);
    return {
      stage: 'generate',
      success: false,
      outputFiles: [],
      errors: [`ComfyUI job submission failed: ${msg}`],
      duration: Date.now() - startTime,
    };
  }

  // 6. Poll GET /jobs/:id until complete or timeout
  // The Express service handles the WebSocket internally — generate.ts polls /jobs/:id for status.
  // Polling interval: 2s. Total timeout: 95s (slightly over service's 90s to surface service error).
  const POLL_INTERVAL_MS = 2000;
  const POLL_TIMEOUT_MS = 95_000;
  const pollStart = Date.now();

  interface JobStatusResponse {
    jobId: string;
    status: 'queued' | 'running' | 'complete' | 'failed';
    imageFile?: string;
    imagePath?: string;
    error?: string;
  }

  let finalJobState: JobStatusResponse | null = null;
  while (Date.now() - pollStart < POLL_TIMEOUT_MS) {
    await new Promise(r => setTimeout(r, POLL_INTERVAL_MS));
    try {
      const statusRes = await fetch(`http://127.0.0.1:3000/jobs/${jobId}`);
      const jobState = await statusRes.json() as JobStatusResponse;
      console.log(`[generate] Job ${jobId} status: ${jobState.status}`);

      if (jobState.status === 'complete') {
        finalJobState = jobState;
        break;
      }
      if (jobState.status === 'failed') {
        return {
          stage: 'generate',
          success: false,
          outputFiles: [],
          errors: [`ComfyUI job failed: ${jobState.error ?? 'unknown error'}`],
          duration: Date.now() - startTime,
        };
      }
    } catch (error) {
      const msg = error instanceof Error ? error.message : String(error);
      return {
        stage: 'generate',
        success: false,
        outputFiles: [],
        errors: [`Service connection lost: ${msg}`],
        duration: Date.now() - startTime,
      };
    }
  }

  if (!finalJobState) {
    return {
      stage: 'generate',
      success: false,
      outputFiles: [],
      errors: ['ComfyUI job timed out after 95s (generate stage). Run `pnpm start:service` and retry.'],
      duration: Date.now() - startTime,
    };
  }

  // 7. Record in manifest (imagePath from service points to raw/comfyui/ file)
  const imagePath = finalJobState.imagePath ?? path.join(comfyuiDir, imageFile);
  const manifest = await loadManifest(chapterPaths.root, options.chapter);
  const entry: GenerationLogEntry = {
    imageFile,
    promptFile: path.join('prompts', promptFilename),
    promptHash: hashPrompt(promptText),
    model: 'comfyui',
    timestamp: new Date().toISOString(),
    version,
    approved: false,
    promptText,
    source: 'comfyui',
    sourcePath: imagePath,
  };
  await addEntry(chapterPaths.root, manifest, entry);

  const chNum = String(options.chapter).padStart(2, '0');
  console.log(`[generate] ComfyUI image saved to: output/ch-${chNum}/raw/comfyui/${imageFile}`);
  console.log(`[generate] To approve and promote: pnpm stage:generate -- --approve ${imageFile} -c ${options.chapter}`);

  return {
    stage: 'generate',
    success: true,
    outputFiles: [imagePath],
    errors: [],
    duration: Date.now() - startTime,
  };
}
```

Add any missing imports at the top of `generate.ts` (e.g., `hashPrompt`). The `readFile`, `existsSync`, `path`, `loadManifest`, `addEntry`, `ensureDir`, `panelImageFilename`, `nextVersion` are already imported. Add `hashPrompt` import from `../generation/manifest.js` if not already present.
  </action>
  <verify>
```
cd /Users/dondemetrius/Code/plasma/pipeline && pnpm typecheck
```
With ComfyUI running and `pnpm start:service` running in a separate terminal:
```
pnpm stage:generate -- --comfyui -c 1 --page 1
```
Confirm: no errors, image appears in `output/ch-01/raw/comfyui/ch01_p001_v1.png`. Then approve:
```
pnpm stage:generate -- --approve ch01_p001_v1.png -c 1
```
Confirm: image copied to `output/ch-01/raw/ch01_p001_v1.png`.

Run the overlay stage (confirming PIPE-03 — no overlay changes needed):
```
pnpm stage:overlay -- -c 1 --page 1
```
Confirm: overlay runs on the promoted image without errors.
  </verify>
  <done>
`pnpm typecheck` passes. `pnpm stage:generate -- --comfyui -c 1 --page 1` completes and writes `ch01_p001_v1.png` to `output/ch-01/raw/comfyui/`. Approval promotes to `output/ch-01/raw/`. Overlay stage processes the image without code changes. All Phase 7 success criteria satisfied.
  </done>
</task>

</tasks>

<verification>
End-to-end checklist for Phase 7 success criteria:
1. `pnpm stage:generate -- --comfyui -c 1 --page 1` completes, image in `output/ch-01/raw/` after approval with naming `ch01_pNNN_vN.png`
2. `GET /health` returns `{ status: "ok", comfyui: true, mps: true }` when ComfyUI is running
3. `POST /jobs` with width > 512 returns HTTP 400
4. `POST /jobs` with height > 768 returns HTTP 400
5. `POST /jobs` valid payload: WS established before POST /prompt (verify via service logs showing "WS open" before "Job submitted")
6. `pnpm stage:overlay -- -c 1 --page 1` runs on promoted ComfyUI image without errors
7. `pnpm stage:generate -- -c 1` (no mode flag) exits with clear error message
</verification>

<success_criteria>
`pnpm stage:generate -- --comfyui -c 1 --page 1` is a working command that completes the full generation loop. Gemini and manual modes unchanged. No overlay or assemble code modified. All 8 Phase 7 requirements (GEN-01 through GEN-05, PIPE-01 through PIPE-03) are satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/07-comfyui-express-integration/07-03-SUMMARY.md`
</output>
