---
phase: 07-comfyui-express-integration
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - pipeline/package.json
  - pipeline/src/comfyui/types.ts
  - pipeline/src/comfyui/job-store.ts
  - pipeline/src/comfyui/slot-fill.ts
  - pipeline/src/comfyui/service.ts
  - pipeline/src/comfyui/router.ts
  - pipeline/src/comfyui/workflows/txt2img-lora.json
  - pipeline/src/comfyui/workflows/img2img-lora-controlnet.json
autonomous: true
requirements:
  - GEN-01
  - GEN-03
  - GEN-04
  - GEN-05

must_haves:
  truths:
    - "Express service starts on port 3000 via `pnpm start:service` and logs startup message"
    - "`GET /health` returns `{ status: 'ok', comfyui: true, mps: true }` when ComfyUI is reachable, 503 when not"
    - "`POST /jobs` with width > 512 or height > 768 or batch_size > 1 returns HTTP 400 with structured `{ error, field }` body"
    - "Workflow templates exist with `{{PLACEHOLDER}}` tokens and ModelComputeDtype VAE fp32 node"
    - "Slot-fill correctly replaces all 5 tokens; seed token is replaced as integer (not string)"
  artifacts:
    - path: "pipeline/src/comfyui/types.ts"
      provides: "JobRequest, JobState, ComfyMessage types"
      exports: ["JobRequest", "JobState", "ComfyMessage", "JobStatus"]
    - path: "pipeline/src/comfyui/job-store.ts"
      provides: "In-memory Map<jobId, JobState> with CRUD helpers"
      exports: ["createJob", "getJob", "updateJob"]
    - path: "pipeline/src/comfyui/slot-fill.ts"
      provides: "Template token replacement for 5 fields"
      exports: ["slotFill"]
    - path: "pipeline/src/comfyui/service.ts"
      provides: "Express app entry point"
      contains: "app.listen(3000"
    - path: "pipeline/src/comfyui/router.ts"
      provides: "Express router with /health, POST /jobs, GET /jobs/:id stubs"
      contains: "router.post('/jobs'"
    - path: "pipeline/src/comfyui/workflows/txt2img-lora.json"
      provides: "Active Phase 7 workflow template"
      contains: "ModelComputeDtype"
    - path: "pipeline/src/comfyui/workflows/img2img-lora-controlnet.json"
      provides: "Stub scaffold for Phase 10"
      contains: "img2img"
  key_links:
    - from: "pipeline/src/comfyui/service.ts"
      to: "pipeline/src/comfyui/router.ts"
      via: "app.use('/', createJobRouter())"
      pattern: "createJobRouter"
    - from: "pipeline/src/comfyui/router.ts"
      to: "pipeline/src/comfyui/slot-fill.ts"
      via: "import slotFill"
      pattern: "slotFill"
---

<objective>
Scaffold the Express service infrastructure: install deps, create all supporting modules (types, job-store, slot-fill), implement the HTTP layer with validation, and write the workflow JSON templates with correct VAE fp32 override.

Purpose: Establishes the complete service skeleton — router, validation, templates — so Plan 02 only needs to add the ComfyUI WebSocket client and wire it into the job handler.
Output: A running Express server on port 3000 with full validation, a stubbed job handler (returns 501 until Plan 02), and two workflow JSON templates.
</objective>

<execution_context>
@/Users/dondemetrius/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dondemetrius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-comfyui-express-integration/07-CONTEXT.md
@.planning/phases/07-comfyui-express-integration/07-RESEARCH.md
@pipeline/src/config/paths.ts
@pipeline/src/types/generation.ts
@pipeline/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install deps and create shared types + job-store + slot-fill</name>
  <files>
    pipeline/package.json
    pipeline/src/comfyui/types.ts
    pipeline/src/comfyui/job-store.ts
    pipeline/src/comfyui/slot-fill.ts
  </files>
  <action>
**Install new deps** (from pipeline/ directory):
```
pnpm add express ws
pnpm add -D @types/express @types/ws
```
Add `"start:service": "tsx src/comfyui/service.ts"` to the `scripts` block in `pipeline/package.json`.

**Create `pipeline/src/comfyui/types.ts`:**
```typescript
import type { z } from 'zod';
import type { jobRequestSchema } from './router.js';

export type JobStatus = 'queued' | 'running' | 'complete' | 'failed';

export interface JobState {
  jobId: string;
  status: JobStatus;
  promptId?: string;
  imagePath?: string;   // absolute path to image in raw/comfyui/
  imageFile?: string;   // bare filename e.g. ch01_p001_v1.png
  error?: string;
  createdAt: string;    // ISO 8601
  updatedAt: string;    // ISO 8601
}

export interface ComfyMessage {
  type: string;
  data: {
    node: string | null;
    prompt_id?: string;
    value?: number;
    max?: number;
  };
}

export interface HistoryEntry {
  outputs: Record<string, {
    images: Array<{
      filename: string;
      subfolder: string;
      type: 'output' | 'temp' | 'input';
    }>;
  }>;
  status: { completed: boolean };
}
```
Note: `jobRequestSchema` import will be resolved when router.ts is created in the same plan. To avoid circular deps, define `JobRequest` directly in types.ts without importing from router.ts:
```typescript
export interface JobRequest {
  prompt_text: string;
  negative_prompt?: string;
  seed?: number;
  steps?: number;
  cfg?: number;
  sampler?: string;
  scheduler?: string;
  resolution: { width: number; height: number };
  checkpoint_name?: string;
}
```

**Create `pipeline/src/comfyui/job-store.ts`:**
- Use `Map<string, JobState>` module-level singleton
- Export `createJob(req: Partial<JobState>): JobState` — generates UUID via `randomUUID()` from `node:crypto`, sets `status: 'queued'`, sets timestamps
- Export `getJob(jobId: string): JobState | undefined`
- Export `updateJob(jobId: string, patch: Partial<JobState>): JobState | undefined` — merges patch, updates `updatedAt`

**Create `pipeline/src/comfyui/slot-fill.ts`:**
- Export `slotFill(templateJson: string, values: Record<string, string | number>): string`
- Replaces `{{PROMPT_TEXT}}`, `{{NEGATIVE_PROMPT}}`, `{{SEED}}`, `{{LORA_NAME}}`, `{{CHECKPOINT_NAME}}`
- CRITICAL: seed must be replaced as integer in JSON. Template has `"{{SEED}}"` (with quotes). Replace `"{{SEED}}"` with the raw number `String(seed)` — so `"{{SEED}}"` → `12345` not `"12345"`. Use: `json.replace('"{{SEED}}"', String(values.seed))`
- All other tokens: `replaceAll('{{TOKEN}}', String(value))`
- Export `TOKENS` const with the 5 token name mappings for documentation
  </action>
  <verify>
Run from `/Users/dondemetrius/Code/plasma/pipeline`:
```
pnpm typecheck
```
No TypeScript errors. Confirm `node_modules/express` and `node_modules/ws` exist.
  </verify>
  <done>
`pipeline/package.json` has `express`, `ws` in dependencies and `@types/express`, `@types/ws` in devDependencies. `start:service` script exists. All three modules typecheck cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create workflow templates and Express service + router</name>
  <files>
    pipeline/src/comfyui/workflows/txt2img-lora.json
    pipeline/src/comfyui/workflows/img2img-lora-controlnet.json
    pipeline/src/comfyui/service.ts
    pipeline/src/comfyui/router.ts
  </files>
  <action>
**Create `pipeline/src/comfyui/workflows/txt2img-lora.json`:**

Full ComfyUI API-format workflow with 8 nodes. Node IDs must be stable strings. Use this exact structure (GEN-04 slot tokens + GEN-05 ModelComputeDtype node):

```json
{
  "1": {
    "class_type": "CheckpointLoaderSimple",
    "inputs": { "ckpt_name": "{{CHECKPOINT_NAME}}" }
  },
  "2": {
    "class_type": "CLIPTextEncode",
    "inputs": { "text": "{{PROMPT_TEXT}}", "clip": ["1", 1] }
  },
  "3": {
    "class_type": "CLIPTextEncode",
    "inputs": { "text": "{{NEGATIVE_PROMPT}}", "clip": ["1", 1] }
  },
  "4": {
    "class_type": "EmptyLatentImage",
    "inputs": { "width": 512, "height": 768, "batch_size": 1 }
  },
  "5": {
    "class_type": "KSampler",
    "inputs": {
      "model": ["10", 0],
      "positive": ["2", 0],
      "negative": ["3", 0],
      "latent_image": ["4", 0],
      "seed": "{{SEED}}",
      "steps": 20,
      "cfg": 7,
      "sampler_name": "euler_ancestral",
      "scheduler": "normal",
      "denoise": 1
    }
  },
  "6": {
    "class_type": "VAEDecode",
    "inputs": { "samples": ["5", 0], "vae": ["1", 2] }
  },
  "7": {
    "class_type": "SaveImage",
    "inputs": { "images": ["6", 0], "filename_prefix": "plasma" }
  },
  "10": {
    "class_type": "ModelComputeDtype",
    "inputs": { "model": ["1", 0], "dtype": "fp32" }
  }
}
```
Note: KSampler's `model` input is `["10", 0]` (through ModelComputeDtype), not `["1", 0]` directly. Node `"7"` is the SaveImage — `SAVE_NODE_ID = '7'` in comfyui-client.ts. `{{SEED}}` has surrounding quotes in JSON — slot-fill must strip them. The `{{LORA_NAME}}` token is NOT in this template (no LoRA node in Phase 7 per user decision). `checkpoint_name` defaults to `"AnythingXL_inkBase.safetensors"` in the router if not provided by caller.

**Create `pipeline/src/comfyui/workflows/img2img-lora-controlnet.json`:**

Stub scaffold for Phase 10 — valid JSON but no real nodes. Include a comment field (use `"_comment"` key) explaining it's a Phase 10 placeholder:
```json
{
  "_comment": "Phase 10 stub — img2img + ControlNet OpenPose template. To be implemented in Phase 10.",
  "_phase": "10",
  "_status": "stub"
}
```

**Create `pipeline/src/comfyui/service.ts`:**

Express entry point. Keep it minimal:
```typescript
import express from 'express';
import { createJobRouter } from './router.js';

const app = express();
app.use(express.json());
app.use('/', createJobRouter());

const PORT = 3000;
app.listen(PORT, '127.0.0.1', () => {
  console.log(`[service] ComfyUI Express bridge listening on http://127.0.0.1:${PORT}`);
  console.log(`[service] ComfyUI target: http://127.0.0.1:8188`);
  console.log(`[service] Use Ctrl+C to stop`);
});
```
Port is not configurable (per user decision — 3000 is hardcoded).

**Create `pipeline/src/comfyui/router.ts`:**

Full router with validation and all required endpoints. Imports `zod` (already in deps) for validation.

```typescript
import { Router } from 'express';
import { z } from 'zod';
import { createJob, getJob } from './job-store.js';
import { slotFill } from './slot-fill.js';
import { readFileSync } from 'node:fs';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const WORKFLOWS_DIR = path.join(__dirname, 'workflows');
const COMFYUI_URL = 'http://127.0.0.1:8188';
const DEFAULT_CHECKPOINT = 'AnythingXL_inkBase.safetensors';
const DEFAULT_NEGATIVE = 'lowres, bad anatomy, bad hands, text, error, missing fingers';
const DEFAULT_STEPS = 20;
const DEFAULT_CFG = 7;
const DEFAULT_SAMPLER = 'euler_ancestral';
const DEFAULT_SCHEDULER = 'normal';
```

**Zod schema for POST /jobs body** (GEN-03 validation):
```typescript
export const jobRequestSchema = z.object({
  prompt_text: z.string().min(1),
  negative_prompt: z.string().optional(),
  seed: z.number().int().optional(),
  steps: z.number().int().min(1).max(150).optional(),
  cfg: z.number().min(1).max(30).optional(),
  sampler: z.string().optional(),
  scheduler: z.string().optional(),
  resolution: z.object({
    width: z.number().int().min(1),
    height: z.number().int().min(1),
  }),
  checkpoint_name: z.string().optional(),
});
```

**`GET /health` handler:**
- Call `fetch('http://127.0.0.1:8188/system_stats', { signal: AbortSignal.timeout(2000) })`
- If ok: respond `200 { status: 'ok', comfyui: true, mps: true }` (mps hardcoded per research — Phase 5 confirmed MPS active)
- If error/timeout: respond `503 { status: 'error', comfyui: false, mps: false }`
- Log every health check to console: `[service] GET /health -> comfyui: true/false`

**`POST /jobs` handler:**
- Parse body with `jobRequestSchema.safeParse(req.body)`
- If invalid: return `400 { error: err.errors[0].message, field: err.errors[0].path.join('.') }`
- Validate resolution constraints (GEN-03): if `width > 512`: return `400 { error: 'width must be <= 512', field: 'resolution.width' }`. If `height > 768`: return `400 { error: 'height must be <= 768', field: 'resolution.height' }`. If body contains `batch_size > 1` (not in schema but check raw body): return `400 { error: 'batch_size must be 1', field: 'batch_size' }`.
- Create job in store: `const job = createJob({ status: 'queued' })`
- Log: `[service] POST /jobs -> jobId: ${job.jobId}, prompt: ${body.prompt_text.slice(0, 50)}...`
- Respond immediately: `202 { jobId: job.jobId, status: 'queued' }`
- Fire-and-forget async job execution (import comfyui-client in Plan 02 will replace this stub): `setImmediate(async () => { /* TODO: Plan 02 wires ComfyUI execution here */ })`

**`GET /jobs/:id` handler:**
- Look up job in store
- If not found: `404 { error: 'Job not found', field: 'jobId' }`
- Return `200 { ...job }`
- Log: `[service] GET /jobs/${id} -> status: ${job.status}`

**`POST /loras/train` handler (GEN-01 stub):**
- Return `501 { error: 'Not implemented — Phase 9' }`

**`GET /loras/:id/status` handler (GEN-01 stub):**
- Return `501 { error: 'Not implemented — Phase 9' }`

Export `createJobRouter()` function that creates and returns the configured router.
  </action>
  <verify>
From `/Users/dondemetrius/Code/plasma/pipeline`:
```
pnpm typecheck
```
No TypeScript errors. Then start the service:
```
pnpm start:service
```
In a second terminal, test:
```
curl http://127.0.0.1:3000/health
curl -X POST http://127.0.0.1:3000/jobs -H "Content-Type: application/json" -d '{"prompt_text":"test","resolution":{"width":600,"height":512}}'
curl -X POST http://127.0.0.1:3000/jobs -H "Content-Type: application/json" -d '{"prompt_text":"test","resolution":{"width":512,"height":900}}'
```
Stop service with Ctrl+C after verifying.
  </verify>
  <done>
`pnpm typecheck` passes. Service starts and logs startup message. `/health` returns JSON (503 if ComfyUI not running — that is correct). `POST /jobs` with `width: 600` returns `400 { error: 'width must be <= 512', field: 'resolution.width' }`. `POST /jobs` with `height: 900` returns `400 { error: 'height must be <= 768', field: 'resolution.height' }`. `POST /jobs` with valid payload returns `202 { jobId: '...', status: 'queued' }`.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` in pipeline/ passes with zero errors
2. `pnpm start:service` starts and prints the startup log line
3. Resolution validation returns correct 400 + structured error body
4. Workflow templates exist at the correct paths with ModelComputeDtype node in txt2img-lora.json
5. `package.json` has express, ws in deps and start:service script
</verification>

<success_criteria>
Express service scaffolded and functional: validation works, health endpoint works, job creation returns 202 and stores state. Templates are on disk and parseable as JSON. Service starts without errors via `pnpm start:service`. Ready for Plan 02 to wire in the actual ComfyUI client.
</success_criteria>

<output>
After completion, create `.planning/phases/07-comfyui-express-integration/07-01-SUMMARY.md`
</output>
