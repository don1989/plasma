---
phase: 07-comfyui-express-integration
plan: "02"
type: execute
wave: 2
depends_on:
  - "07-01"
files_modified:
  - pipeline/src/comfyui/comfyui-client.ts
  - pipeline/src/comfyui/router.ts
autonomous: true
requirements:
  - GEN-02
  - GEN-05

must_haves:
  truths:
    - "WebSocket connection to ComfyUI is established BEFORE POST /prompt is called — no exceptions"
    - "Job completion is detected via `{ type: 'executing', data: { node: null, prompt_id } }` WebSocket message"
    - "Job times out after 90s with clear error; no image written on timeout"
    - "`POST /jobs` async execution calls the ComfyUI client, updates job state in store, retrieves image from ComfyUI output directory"
    - "Image is copied from ComfyUI output to output/ch-XX/raw/comfyui/ with correct chXX_pNNN_vN.png naming"
  artifacts:
    - path: "pipeline/src/comfyui/comfyui-client.ts"
      provides: "WebSocket + REST wrapper for ComfyUI API"
      exports: ["submitJob", "ComfyJobInput", "ComfyJobResult"]
    - path: "pipeline/src/comfyui/router.ts"
      provides: "Updated POST /jobs handler calling comfyui-client"
      contains: "submitJob"
  key_links:
    - from: "pipeline/src/comfyui/router.ts"
      to: "pipeline/src/comfyui/comfyui-client.ts"
      via: "import { submitJob }"
      pattern: "submitJob"
    - from: "pipeline/src/comfyui/comfyui-client.ts"
      to: "ws://127.0.0.1:8188/ws"
      via: "new WebSocket(url)"
      pattern: "new WebSocket"
    - from: "pipeline/src/comfyui/comfyui-client.ts"
      to: "http://127.0.0.1:8188/prompt"
      via: "fetch after ws.open"
      pattern: "fetch.*8188/prompt"
---

<objective>
Implement the ComfyUI WebSocket + REST client and wire it into the POST /jobs router handler so that submitting a job actually triggers ComfyUI generation, detects completion via WebSocket, and retrieves the output image.

Purpose: This is the core integration — the WS-before-POST ordering constraint (GEN-02) is the highest-risk implementation detail in the phase. Getting this right means the end-to-end loop works.
Output: comfyui-client.ts with the full job execution pipeline; updated router.ts that replaces the Plan 01 stub with real async execution.
</objective>

<execution_context>
@/Users/dondemetrius/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dondemetrius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/07-comfyui-express-integration/07-CONTEXT.md
@.planning/phases/07-comfyui-express-integration/07-RESEARCH.md
@.planning/phases/07-comfyui-express-integration/07-01-SUMMARY.md
@pipeline/src/comfyui/types.ts
@pipeline/src/comfyui/job-store.ts
@pipeline/src/comfyui/slot-fill.ts
@pipeline/src/comfyui/router.ts
@pipeline/src/comfyui/workflows/txt2img-lora.json
@pipeline/src/config/paths.ts
@pipeline/src/generation/naming.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement comfyui-client.ts with WebSocket-before-POST pattern</name>
  <files>
    pipeline/src/comfyui/comfyui-client.ts
  </files>
  <action>
Create `pipeline/src/comfyui/comfyui-client.ts`. This module is the critical integration layer.

**Imports and constants:**
```typescript
import { WebSocket } from 'ws';
import { randomUUID } from 'node:crypto';
import { copyFile } from 'node:fs/promises';
import path from 'node:path';
import type { ComfyMessage, HistoryEntry } from './types.js';
import { slotFill } from './slot-fill.js';
import { readFileSync } from 'node:fs';
import { fileURLToPath } from 'node:url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const COMFYUI_URL = 'http://127.0.0.1:8188';
const COMFYUI_WS = 'ws://127.0.0.1:8188';
const TIMEOUT_MS = 90_000;
const SAVE_NODE_ID = '7';  // Must match SaveImage node ID in txt2img-lora.json
const COMFYUI_OUTPUT_DIR = path.join(process.env['HOME'] ?? '/Users/plasma', 'tools', 'ComfyUI', 'output');
```

**Export interface `ComfyJobInput`:**
```typescript
export interface ComfyJobInput {
  promptText: string;
  negativePrompt?: string;
  seed: number;
  steps?: number;
  cfg?: number;
  sampler?: string;
  scheduler?: string;
  checkpointName?: string;
  destDir: string;      // absolute path to raw/comfyui/ directory
  chapter: number;
  page: number;
  version: number;
}
```

**Export interface `ComfyJobResult`:**
```typescript
export interface ComfyJobResult {
  promptId: string;
  imagePath: string;   // absolute path to copied image in raw/comfyui/
  imageFile: string;   // bare filename e.g. ch01_p001_v1.png
}
```

**Export async function `submitJob(input: ComfyJobInput): Promise<ComfyJobResult>`:**

Implement the exact sequence from research (GEN-02 — no deviation allowed):

1. **Load and slot-fill template:**
   ```typescript
   const templatePath = path.join(__dirname, 'workflows', 'txt2img-lora.json');
   const templateJson = readFileSync(templatePath, 'utf-8');
   const seed = input.seed ?? Math.floor(Math.random() * 2_147_483_647);
   const filledJson = slotFill(templateJson, {
     PROMPT_TEXT: input.promptText,
     NEGATIVE_PROMPT: input.negativePrompt ?? 'lowres, bad anatomy, bad hands, text, error, missing fingers',
     SEED: seed,
     LORA_NAME: '',        // Phase 7: no LoRA — Phase 9 wires this
     CHECKPOINT_NAME: input.checkpointName ?? 'AnythingXL_inkBase.safetensors',
   });
   const workflow = JSON.parse(filledJson);
   ```

2. **Generate client_id:**
   ```typescript
   const clientId = randomUUID();
   ```

3. **STEP 1 — Open WebSocket FIRST (CRITICAL — GEN-02):**
   ```typescript
   const ws = new WebSocket(`${COMFYUI_WS}/ws?clientId=${clientId}`);
   await new Promise<void>((resolve, reject) => {
     ws.once('open', () => {
       console.log(`[comfyui-client] WS open, clientId=${clientId}`);
       resolve();
     });
     ws.once('error', reject);
   });
   ```

4. **STEP 2 — POST workflow AFTER WS is open:**
   ```typescript
   const promptRes = await fetch(`${COMFYUI_URL}/prompt`, {
     method: 'POST',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify({ prompt: workflow, client_id: clientId }),
   });
   if (!promptRes.ok) {
     ws.close();
     throw new Error(`ComfyUI POST /prompt failed: ${promptRes.status} ${await promptRes.text()}`);
   }
   const { prompt_id } = await promptRes.json() as { prompt_id: string };
   console.log(`[comfyui-client] Job submitted, prompt_id=${prompt_id}`);
   ```

5. **STEP 3 — Wait for completion via WebSocket:**

   Implement `waitForCompletion(ws, promptId, timeoutMs)` as a local async function:
   - Listen for `message` events; parse JSON as `ComfyMessage`
   - Complete when: `msg.type === 'executing' && msg.data.node === null && msg.data.prompt_id === promptId`
   - Timeout after 90s: `ws.close(); throw new Error('ComfyUI job timed out after 90s')`
   - Log progress: when `msg.type === 'progress'`, log `[comfyui-client] progress: ${msg.data.value}/${msg.data.max}`
   - Do NOT use `execution_success` (ComfyUI issue #11540 — fires before outputs are persisted)

6. **STEP 4 — Retrieve image from history:**
   ```typescript
   ws.close();
   // Small guard: verify outputs are present
   const histRes = await fetch(`${COMFYUI_URL}/history/${prompt_id}`);
   const history = await histRes.json() as Record<string, HistoryEntry>;
   const entry = history[prompt_id];
   const outputImages = entry?.outputs?.[SAVE_NODE_ID]?.images ?? [];
   if (outputImages.length === 0) {
     throw new Error(`No output images in ComfyUI history for prompt_id=${prompt_id}`);
   }
   const img = outputImages[0]!;
   const srcPath = path.join(COMFYUI_OUTPUT_DIR, img.subfolder, img.filename);
   ```

7. **STEP 5 — Copy to pipeline output directory:**
   ```typescript
   const { panelImageFilename } = await import('../generation/naming.js');
   const imageFile = panelImageFilename(input.chapter, input.page, input.version);
   const destPath = path.join(input.destDir, imageFile);
   await copyFile(srcPath, destPath);
   console.log(`[comfyui-client] Image saved: ${destPath}`);
   return { promptId: prompt_id, imagePath: destPath, imageFile };
   ```

All errors must propagate (no silent swallowing) — the router's error handler will update job state to 'failed'.
  </action>
  <verify>
```
cd /Users/dondemetrius/Code/plasma/pipeline && pnpm typecheck
```
No TypeScript errors. Confirm WebSocket import resolves correctly (`import { WebSocket } from 'ws'`).
  </verify>
  <done>
`pipeline/src/comfyui/comfyui-client.ts` exists, typechecks cleanly, exports `submitJob`, `ComfyJobInput`, `ComfyJobResult`. WS open is awaited before fetch call.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire comfyui-client into router POST /jobs async handler</name>
  <files>
    pipeline/src/comfyui/router.ts
  </files>
  <action>
Update `pipeline/src/comfyui/router.ts` to replace the Plan 01 `setImmediate` stub with real ComfyUI job execution.

**Add imports at top of router.ts:**
```typescript
import { submitJob } from './comfyui-client.js';
import { updateJob } from './job-store.js';
import { randomInt } from 'node:crypto';
import { mkdir } from 'node:fs/promises';
import { PATHS } from '../config/paths.js';
```

**Replace the `POST /jobs` fire-and-forget section** (the `setImmediate` stub from Plan 01) with:

```typescript
// Fire-and-forget async execution
setImmediate(async () => {
  try {
    const chapter = body.resolution?.chapter ?? 1;  // default ch01 for Phase 7
    const page = (body as Record<string, unknown>).page as number | undefined ?? 1;
    const chapterPaths = PATHS.chapterOutput(chapter);
    const comfyuiDir = `${chapterPaths.raw}/comfyui`;
    await mkdir(comfyuiDir, { recursive: true });

    // Determine version — scan comfyui subdir for existing files
    const { nextVersion } = await import('../generation/naming.js');
    const version = nextVersion(comfyuiDir, chapter, page);

    updateJob(job.jobId, { status: 'running' });

    const result = await submitJob({
      promptText: body.prompt_text,
      negativePrompt: body.negative_prompt,
      seed: body.seed ?? randomInt(2_147_483_647),
      steps: body.steps ?? 20,
      cfg: body.cfg ?? 7,
      sampler: body.sampler,
      scheduler: body.scheduler,
      checkpointName: body.checkpoint_name,
      destDir: comfyuiDir,
      chapter,
      page,
      version,
    });

    updateJob(job.jobId, {
      status: 'complete',
      promptId: result.promptId,
      imagePath: result.imagePath,
      imageFile: result.imageFile,
    });

    console.log(`[service] Job ${job.jobId} complete -> ${result.imageFile}`);
  } catch (err) {
    const msg = err instanceof Error ? err.message : String(err);
    console.error(`[service] Job ${job.jobId} failed: ${msg}`);
    updateJob(job.jobId, { status: 'failed', error: msg });
  }
});
```

Note: `chapter` and `page` are not in the current `jobRequestSchema` — the schema doesn't include them because Phase 7's CLI integration (Plan 03) passes them separately via the CLI. For Phase 7, the generate.ts client will embed chapter/page in the job request body. Update `jobRequestSchema` to include optional `chapter` and `page` fields:
```typescript
export const jobRequestSchema = z.object({
  // ... existing fields ...
  chapter: z.number().int().min(1).optional(),
  page: z.number().int().min(1).optional(),
});
```
And in the POST handler, extract them: `const chapter = body.chapter ?? 1; const page = body.page ?? 1;`

Log job completion verbosely — both success and failure — per user decision (verbose logging).
  </action>
  <verify>
```
cd /Users/dondemetrius/Code/plasma/pipeline && pnpm typecheck
```
Start ComfyUI (`cd ~/tools/ComfyUI && python main.py --force-fp16`), then start the service (`pnpm start:service`). Test end-to-end:
```
curl -X POST http://127.0.0.1:3000/jobs \
  -H "Content-Type: application/json" \
  -d '{"prompt_text":"anime girl, simple background","resolution":{"width":512,"height":768},"chapter":1,"page":1}'
```
Poll job status until complete:
```
curl http://127.0.0.1:3000/jobs/{jobId}
```
Confirm `status: 'complete'` and `imageFile` field is set. Confirm image exists at `output/ch-01/raw/comfyui/ch01_p001_v1.png`.
  </verify>
  <done>
`pnpm typecheck` passes. When ComfyUI is running: `POST /jobs` returns 202, job progresses to `status: 'complete'`, image file `ch01_p001_v1.png` exists in `output/ch-01/raw/comfyui/`. Service logs show WS connection, progress, and completion.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes with zero errors
2. `submitJob` correctly opens WebSocket before posting to /prompt
3. WS completion detection uses `executing + node:null` (not `execution_success`)
4. 90s timeout results in thrown error and job state set to 'failed'
5. Successful job: image copied to `output/ch-01/raw/comfyui/ch01_p001_v1.png`
6. GET /jobs/:id returns updated status after completion
</verification>

<success_criteria>
The Express service handles full job lifecycle: receive request → validate → store → submit to ComfyUI via WS-before-POST → detect completion → retrieve image → copy to output directory → update job state. ComfyUI integration is complete and ready for pipeline wiring in Plan 03.
</success_criteria>

<output>
After completion, create `.planning/phases/07-comfyui-express-integration/07-02-SUMMARY.md`
</output>
