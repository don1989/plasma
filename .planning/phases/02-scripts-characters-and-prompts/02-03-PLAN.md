---
phase: 02-scripts-characters-and-prompts
plan: 03
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - pipeline/src/characters/registry.ts
  - pipeline/data/characters/spyke-tinwall.yaml
  - pipeline/data/characters/june-kamara.yaml
  - pipeline/data/characters/draster.yaml
  - pipeline/data/characters/hood-morkain.yaml
  - pipeline/data/characters/punks.yaml
  - pipeline/data/config/style-guide.yaml
  - pipeline/src/cli.ts
  - pipeline/tests/characters/registry.test.ts
autonomous: true
requirements: [CHAR-01, CHAR-03, CHAR-04]

must_haves:
  truths:
    - "Each main character has a YAML file with a locked prompt fingerprint"
    - "CharacterRegistry loads all YAML files and provides case-insensitive lookup by id or alias"
    - "Looking up 'Spyke', 'SPYKE', 'spyke', or 'spyke-tinwall' returns the same fingerprint"
    - "Invalid YAML files produce validation errors, not crashes"
    - "CLI has a 'character add' subcommand that scaffolds a new character YAML file"
    - "CLI has a 'character ref-sheet' subcommand that outputs a reference sheet prompt for a character"
    - "Style guide prefix text is stored in exactly one YAML file"
  artifacts:
    - path: "pipeline/src/characters/registry.ts"
      provides: "CharacterRegistry class with loadAll, get, getFingerprint methods"
      exports: ["CharacterRegistry"]
    - path: "pipeline/data/characters/spyke-tinwall.yaml"
      provides: "Spyke's locked prompt fingerprint"
      contains: "fingerprint"
    - path: "pipeline/data/characters/june-kamara.yaml"
      provides: "June's locked prompt fingerprint"
      contains: "fingerprint"
    - path: "pipeline/data/characters/draster.yaml"
      provides: "Draster's locked prompt fingerprint"
      contains: "fingerprint"
    - path: "pipeline/data/characters/hood-morkain.yaml"
      provides: "Hood/Morkain's locked prompt fingerprint"
      contains: "fingerprint"
    - path: "pipeline/data/config/style-guide.yaml"
      provides: "Style guide prefix text and art settings"
      contains: "style_prefix"
    - path: "pipeline/tests/characters/registry.test.ts"
      provides: "Registry tests for loading, lookup, and validation"
      min_lines: 50
  key_links:
    - from: "pipeline/src/characters/registry.ts"
      to: "pipeline/src/schemas/character.schema.ts"
      via: "validates each YAML file with CharacterFingerprintSchema"
      pattern: "CharacterFingerprintSchema"
    - from: "pipeline/src/characters/registry.ts"
      to: "pipeline/data/characters/"
      via: "reads all .yaml files from the characters directory"
      pattern: "readdir|readFile"
    - from: "pipeline/src/cli.ts"
      to: "pipeline/src/characters/registry.ts"
      via: "character subcommand uses registry"
      pattern: "character"
    - from: "pipeline/src/cli.ts"
      to: "pipeline/data/config/style-guide.yaml"
      via: "character ref-sheet reads style_prefix from style-guide.yaml"
      pattern: "style.guide|style_prefix"
---

<objective>
Create the character fingerprint YAML data files and the CharacterRegistry that loads, validates, and provides case-insensitive lookup for character descriptions. Also create the style guide config and CLI subcommands for listing, adding, and generating reference sheet prompts for characters.

Purpose: Character consistency is the hardest problem in AI manga generation. Every Gemini prompt must embed the full character visual description verbatim. This plan creates the single-source YAML files for character fingerprints and the registry that the template engine will use to inject them. The style guide prefix is also stored here as a single source of truth. The `ref-sheet` subcommand fulfills CHAR-03 by generating a ready-to-use reference sheet prompt before chapter prompts are run.

Output: 5 character YAML files with locked fingerprints, style-guide.yaml, CharacterRegistry class, CLI character subcommands (list, add, ref-sheet), and tests.
</objective>

<execution_context>
@/Users/dondemetrius/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dondemetrius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-scripts-characters-and-prompts/02-01-SUMMARY.md
@pipeline/src/types/characters.ts
@pipeline/src/schemas/character.schema.ts
@pipeline/src/config/paths.ts
@pipeline/src/cli.ts
@03_manga/prompts/character-sheets.md
@03_manga/prompts/pages-01-to-15.md
@03_manga/manga-script.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create character YAML files and style guide config</name>
  <files>
    pipeline/data/characters/spyke-tinwall.yaml
    pipeline/data/characters/june-kamara.yaml
    pipeline/data/characters/draster.yaml
    pipeline/data/characters/hood-morkain.yaml
    pipeline/data/characters/punks.yaml
    pipeline/data/config/style-guide.yaml
  </files>
  <action>
Create the pipeline/data/characters/ and pipeline/data/config/ directories.

Create character YAML files. The fingerprint text MUST come from the existing prompt files (03_manga/prompts/pages-01-to-15.md "Character Quick Reference" section and 03_manga/prompts/character-sheets.md). These are the TESTED descriptions that produce consistent Gemini output. Do NOT paraphrase or rearrange.

**pipeline/data/characters/spyke-tinwall.yaml:**
```yaml
id: spyke-tinwall
name: Spyke Tinwall
aliases: ["Spyke", "SPYKE", "Redhead"]

# Verbatim prompt fingerprint — DO NOT paraphrase or rearrange
# Source: 03_manga/prompts/pages-01-to-15.md Character Quick Reference
fingerprint: |
  Spyke (age 21) — spiky ginger hair (tips reach traps), red bandana,
  green eyes, white knee-length cloak (sleeves cut, dojo emblem on back,
  pattern along bottom hem), red fingerless glove on left hand with red
  bracer on left wrist, armoured full-fingered glove on right hand,
  red-accented belt, metal knee pauldron on right knee, massive broadsword
  on back, patterned katana at left hip, black combat clothing under
  the cloak

reference_sheet_prompt: |
  Colored manga character reference sheet, Spyke Tinwall. Clean linework,
  cel-shaded, vibrant colors, high-resolution, white background.
  Character: Spyke Tinwall, male, age 21, slim but strong athletic build,
  lean muscle definition.
  Hair: Ginger/copper-red hair, messy and layered, length stopping at the
  bottom of the neck (not touching shoulders). Wears a bright red bandana
  tied around the forehead with tails trailing into the hair.
  Eyes: Sharp green eyes.
  Outfit: Black fitted t-shirt worn underneath a White Sleeveless Cloak.
  Cloak Details: The white cloak has a clean hem featuring a black geometric
  pattern running along the bottom edge and a distinct black insignia in
  the center of the back.
  Arms (Asymmetrical): Right Arm: Red fingerless glove that covers the hand
  only and stops at the wrist. Left Arm: Red metallic armored bracer/gauntlet
  that covers the hand and extends up the forearm.
  Legs: Black combat pants with reinforced knees. Right Knee: A metal knee
  pauldron.
  Feet: Dark combat boots.
  Weapons: Back: Massive Plasma Broadsword. Side: Katana sheathed at left hip.

palette:
  primary: ["red (bandana, glove, bracer)", "white (cloak)", "black (combat clothing)"]
  accent: ["ginger (hair)", "green (eyes)", "grey/metallic (broadsword, knee pauldron)"]

variants:
  adrenaline_mode: "eyes turn red, art style becomes sharper/more intense, heavier inks"
  demon_active: "left eye turns purple/black sclera, arm may transform green/purple"
```

Follow the same pattern for June, Draster, Hood, and Punks. Extract fingerprint text from the Character Quick Reference in pages-01-to-15.md and the character-sheets.md file. For Hood, use the description from the Quick Reference. For Punks, create a generic group entry.

**Key aliases to register:**
- June: ["June", "JUNE", "June Kamara"]
- Draster: ["Draster", "DRASTER"]
- Hood: ["Hood", "HOOD", "Morkain", "MORKAIN", "Hood (Morkain)"]
- Punks: ["Punk 1", "PUNK 1", "Punk 2", "PUNK 2", "Punk 3", "PUNK 3", "Punks"]

**pipeline/data/config/style-guide.yaml:**
```yaml
# Style guide prefix — verbatim, included at the top of every prompt
# Source: 03_manga/prompts/pages-01-to-15.md
# DO NOT paraphrase — this exact text produces consistent Gemini output
style_prefix: "Colored manga page, cel-shaded, clean linework, vibrant colors, dynamic panel layout."

# Art style settings
setting: "Year 3031, sci-fi London — vertical tower city above ocean, hover vehicles, holographic tech"

# Weapon rendering note
weapon_glow: "All Plasma weapons emit a faint blue/white energy glow along their cutting edges"
```

Verify each YAML file parses without error: `cd pipeline && node -e "import { parse } from 'yaml'; import { readFileSync } from 'fs'; console.log(parse(readFileSync('data/characters/spyke-tinwall.yaml', 'utf-8')))"` (repeat for each file).
  </action>
  <verify>
All 5 character YAML files and style-guide.yaml exist in pipeline/data/. Each file is valid YAML (parseable without errors). Spyke's fingerprint matches the text from pages-01-to-15.md Character Quick Reference. Style prefix matches the exact text from the existing prompts.
  </verify>
  <done>5 character YAML files created with locked fingerprints sourced from existing prompt files. Style guide config stores the verbatim prefix. All files parse as valid YAML.</done>
</task>

<task type="auto">
  <name>Task 2: Build CharacterRegistry, CLI character subcommands (list, add, ref-sheet)</name>
  <files>
    pipeline/src/characters/registry.ts
    pipeline/src/cli.ts
    pipeline/tests/characters/registry.test.ts
  </files>
  <action>
Create pipeline/src/characters/registry.ts with a `CharacterRegistry` class:

```typescript
class CharacterRegistry {
  private characters: Map<string, CharacterFingerprint> = new Map();

  async loadAll(dirPath: string): Promise<void> {
    // Read all .yaml/.yml files from dirPath
    // Parse each with yaml package
    // Validate each with CharacterFingerprintSchema from character.schema.ts
    // On validation failure: log error with filename and Zod error details, skip file (don't crash)
    // On success: store in map keyed by:
    //   - char.id (lowercase)
    //   - char.name (lowercase)
    //   - each alias (lowercase)
    // All lookups are case-insensitive
  }

  get(nameOrAlias: string): CharacterFingerprint | undefined {
    return this.characters.get(nameOrAlias.toLowerCase());
  }

  getFingerprint(nameOrAlias: string): string {
    const char = this.get(nameOrAlias);
    if (!char) throw new Error(`Unknown character: ${nameOrAlias}`);
    return char.fingerprint;
  }

  getReferenceSheetPrompt(nameOrAlias: string): string | undefined {
    const char = this.get(nameOrAlias);
    if (!char) throw new Error(`Unknown character: ${nameOrAlias}`);
    return char.reference_sheet_prompt;
  }

  has(nameOrAlias: string): boolean {
    return this.characters.has(nameOrAlias.toLowerCase());
  }

  getAll(): CharacterFingerprint[] {
    // Return unique characters (deduplicate aliases pointing to same id)
    return [...new Map([...this.characters.values()].map(c => [c.id, c])).values()];
  }

  get size(): number {
    return this.getAll().length;
  }
}
```

Export both the class and a convenience function:
```typescript
export async function loadCharacterRegistry(dirPath?: string): Promise<CharacterRegistry> {
  const registry = new CharacterRegistry();
  await registry.loadAll(dirPath ?? PATHS.characterData);
  return registry;
}
```

Add a `character` subcommand group to pipeline/src/cli.ts with THREE subcommands:

1. `character list` — loads the registry and prints all characters with their id, name, alias count, and fingerprint length (truncated to first 50 chars).

2. `character add <name>` — scaffolds a new character YAML file in pipeline/data/characters/:
   - Generates id from name (lowercase, spaces to hyphens): "New Character" -> "new-character"
   - Creates `{id}.yaml` with the template structure (id, name, aliases, empty fingerprint placeholder, optional palette/variants sections)
   - Prints the file path and a reminder to fill in the fingerprint field

3. `character ref-sheet <name>` — generates and outputs a complete reference sheet prompt for the named character (CHAR-03):
   - Loads the CharacterRegistry
   - Looks up the character by name/alias (case-insensitive)
   - Reads the `style_prefix` from pipeline/data/config/style-guide.yaml (using the yaml package)
   - If the character has a `reference_sheet_prompt` field, assembles the full prompt by concatenating:
     ```
     {style_prefix}

     {reference_sheet_prompt}

     Layout:
     Main Row: Four full-body views: Front View, 3/4 Angle View, Side Profile View, Back View.
     ```
   - Prints the assembled prompt to stdout (ready for copy-paste into Gemini)
   - If the character has no `reference_sheet_prompt`, prints a warning and exits with error code
   - This does NOT require the Nunjucks template engine — it uses simple string concatenation. The character-sheet.njk template in Plan 04 will later provide the Nunjucks-based version of the same assembly, but this CLI command gives immediate utility without that dependency.

These are lightweight CLI commands — not full stages. They do NOT need StageOptions/StageResult.

Create pipeline/tests/characters/registry.test.ts:
- loadAll loads all YAML files from data/characters/ directory
- Registry size returns correct count of unique characters (5)
- get('spyke') returns Spyke's character data
- get('SPYKE') returns the same data (case-insensitive)
- get('spyke-tinwall') returns the same data (by id)
- getFingerprint('June') returns a string starting with "June" or containing the expected text
- getFingerprint('unknown-character') throws Error
- getReferenceSheetPrompt('Spyke') returns a string containing "reference sheet"
- getReferenceSheetPrompt('unknown-character') throws Error
- has('Hood') returns true
- has('nonexistent') returns false
- getAll() returns 5 unique characters (not duplicated by aliases)
  </action>
  <verify>
Run `cd /Users/dondemetrius/Code/plasma/pipeline && pnpm run test:run -- tests/characters/` — all registry tests pass. Run `pnpm run typecheck` — no type errors. Run `pnpm run dev -- character list` — prints all 5 characters. Run `pnpm run dev -- character add "Test Character"` — creates pipeline/data/characters/test-character.yaml (then delete it). Run `pnpm run dev -- character ref-sheet Spyke` — prints a complete reference sheet prompt starting with the style prefix and containing the reference_sheet_prompt text.
  </verify>
  <done>CharacterRegistry loads 5 character YAML files with case-insensitive lookup. CLI `character list` shows all characters. CLI `character add` scaffolds new YAML files. CLI `character ref-sheet` outputs a complete reference sheet prompt by assembling style prefix + character reference_sheet_prompt + layout instructions. All registry tests pass. Invalid YAML files produce errors without crashing.</done>
</task>

</tasks>

<verification>
- `cd pipeline && pnpm run typecheck` exits 0
- `cd pipeline && pnpm run test:run` — all tests pass
- `pnpm run dev -- character list` prints 5 characters (Spyke, June, Draster, Hood, Punks)
- `pnpm run dev -- character ref-sheet Spyke` outputs a prompt starting with "Colored manga page, cel-shaded..." containing Spyke's reference sheet description and layout instructions
- `pnpm run dev -- character ref-sheet unknown-name` exits with error
- `pipeline/data/characters/` contains 5 YAML files with valid structure
- `pipeline/data/config/style-guide.yaml` contains verbatim style prefix
- Looking up "Spyke", "SPYKE", "spyke-tinwall" all return the same fingerprint
</verification>

<success_criteria>
Character fingerprint system is operational. 5 characters have locked YAML fingerprints sourced from existing tested prompts. Registry provides validated, case-insensitive lookup. Style guide prefix stored in one place. CLI supports listing, adding, and generating reference sheet prompts for characters. The ref-sheet command fulfills CHAR-03 by producing a Gemini-ready reference sheet prompt from the character's YAML data.
</success_criteria>

<output>
After completion, create `.planning/phases/02-scripts-characters-and-prompts/02-03-SUMMARY.md`
</output>
