---
phase: 02-scripts-characters-and-prompts
plan: 04
type: execute
wave: 3
depends_on: [02-02, 02-03]
files_modified:
  - pipeline/src/templates/engine.ts
  - pipeline/src/templates/prompt-generator.ts
  - pipeline/data/templates/page-prompt.njk
  - pipeline/data/templates/character-sheet.njk
  - pipeline/data/templates/partials/style-prefix.njk
  - pipeline/data/templates/partials/character-block.njk
  - pipeline/data/templates/partials/setting-description.njk
  - pipeline/src/stages/prompt.ts
  - pipeline/tests/templates/engine.test.ts
  - pipeline/tests/templates/prompt-generator.test.ts
autonomous: true
requirements: [PRMT-01, PRMT-02, PRMT-03, PRMT-04, PRMT-05]

must_haves:
  truths:
    - "Running the prompt stage for chapter 1 produces 29 prompt text files in output/ch-01/prompts/"
    - "Every generated prompt starts with the verbatim style guide prefix"
    - "Every prompt embeds full character visual descriptions for characters appearing in that page's panels"
    - "Updating a character YAML file changes all prompts on the next generation run"
    - "Updating the style-prefix.njk partial changes all prompts on the next generation run"
    - "Generated prompts match the structure of the hand-written prompts in 03_manga/prompts/"
    - "The setting description from style-guide.yaml is available as a template variable and rendered in the setting-description.njk partial"
  artifacts:
    - path: "pipeline/src/templates/engine.ts"
      provides: "Nunjucks Environment setup with custom filters"
      exports: ["createPromptEngine"]
    - path: "pipeline/src/templates/prompt-generator.ts"
      provides: "Generates page-level prompts from script data + characters + setting"
      exports: ["generateChapterPrompts"]
    - path: "pipeline/data/templates/page-prompt.njk"
      provides: "Main Nunjucks template for per-page prompts"
      contains: "style_prefix"
    - path: "pipeline/data/templates/partials/style-prefix.njk"
      provides: "Locked style guide prefix partial"
      contains: "Colored manga page"
    - path: "pipeline/data/templates/partials/setting-description.njk"
      provides: "Setting description partial rendered from style-guide.yaml setting field"
      contains: "setting"
    - path: "pipeline/src/stages/prompt.ts"
      provides: "Implemented prompt stage wiring parser + registry + templates"
      contains: "generateChapterPrompts"
  key_links:
    - from: "pipeline/src/templates/prompt-generator.ts"
      to: "pipeline/src/characters/registry.ts"
      via: "loads CharacterRegistry to inject fingerprints"
      pattern: "CharacterRegistry|loadCharacterRegistry"
    - from: "pipeline/src/templates/prompt-generator.ts"
      to: "pipeline/data/templates/page-prompt.njk"
      via: "renders template with Nunjucks engine"
      pattern: "render.*page-prompt"
    - from: "pipeline/src/templates/prompt-generator.ts"
      to: "pipeline/data/config/style-guide.yaml"
      via: "reads setting field from style guide and passes to template context"
      pattern: "setting"
    - from: "pipeline/data/templates/page-prompt.njk"
      to: "pipeline/data/templates/partials/style-prefix.njk"
      via: "includes the style prefix partial"
      pattern: "include.*style-prefix"
    - from: "pipeline/data/templates/page-prompt.njk"
      to: "pipeline/data/templates/partials/setting-description.njk"
      via: "includes the setting description partial for establishing shots"
      pattern: "include.*setting-description"
    - from: "pipeline/src/stages/prompt.ts"
      to: "pipeline/src/templates/prompt-generator.ts"
      via: "imports generateChapterPrompts"
      pattern: "import.*generateChapterPrompts"
---

<objective>
Build the Nunjucks template engine and prompt generator that combines parsed script data + character fingerprints + style guide (including setting descriptions) into Gemini-optimized art prompts, one per page.

Purpose: This is the culmination of Phase 2 — the reason the parser and registry exist. The prompt generator automates what was previously hours of manual work: assembling prompts by hand-copying character descriptions and style guides into each page prompt. The templates must produce output matching the quality and structure of the hand-written prompts in 03_manga/prompts/. The template library manages character blocks, style prefix, AND setting descriptions (PRMT-04) as reusable partials.

Output: Working prompt stage that reads script.json + character YAML + style-guide.yaml (including setting) + templates and writes 29 prompt text files to output/ch-01/prompts/.
</objective>

<execution_context>
@/Users/dondemetrius/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dondemetrius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-scripts-characters-and-prompts/02-02-SUMMARY.md
@.planning/phases/02-scripts-characters-and-prompts/02-03-SUMMARY.md
@pipeline/src/types/manga.ts
@pipeline/src/types/characters.ts
@pipeline/src/characters/registry.ts
@pipeline/src/parsers/script-parser.ts
@pipeline/src/stages/prompt.ts
@pipeline/src/config/paths.ts
@pipeline/data/config/style-guide.yaml
@03_manga/prompts/pages-01-to-15.md
@03_manga/prompts/pages-16-to-29.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Nunjucks templates (including setting partial) and template engine</name>
  <files>
    pipeline/src/templates/engine.ts
    pipeline/data/templates/page-prompt.njk
    pipeline/data/templates/character-sheet.njk
    pipeline/data/templates/partials/style-prefix.njk
    pipeline/data/templates/partials/character-block.njk
    pipeline/data/templates/partials/setting-description.njk
    pipeline/tests/templates/engine.test.ts
  </files>
  <action>
Create the template directory structure:
```
pipeline/data/templates/
  page-prompt.njk
  character-sheet.njk
  partials/
    style-prefix.njk
    character-block.njk
    setting-description.njk
```

**pipeline/data/templates/partials/style-prefix.njk:**
```
Colored manga page, cel-shaded, clean linework, vibrant colors, dynamic panel layout.
```
This is the EXACT text from the existing prompts. No newline after it. This partial is included via `{% include %}` — changing it here changes every prompt.

**pipeline/data/templates/partials/character-block.njk:**
```
Character: {{ fingerprint }}
```
Simple block that wraps a character fingerprint with a "Character:" label, matching the format in the hand-written prompts.

**pipeline/data/templates/partials/setting-description.njk:**
```
Setting: {{ setting }}
```
Renders the `setting` value from style-guide.yaml. This partial is included in page-prompt.njk for pages that have establishing shots or wide shots where the setting context matters. The `setting` variable is passed from the prompt generator which reads it from style-guide.yaml. This fulfills PRMT-04's requirement that the template library manages "setting descriptions" as a reusable partial alongside character blocks and style prefix.

**pipeline/data/templates/page-prompt.njk:**
Model this template on the EXACT structure of the hand-written prompts in 03_manga/prompts/pages-01-to-15.md. Study the format carefully:

```
{% include "partials/style-prefix.njk" %}
{% if has_establishing_shot %}
{% include "partials/setting-description.njk" %}
{% endif %}

{{ panel_count }}-panel {{ layout_description }}.
{% for panel in panels %}

PANEL {{ panel.panelNumber }} ({{ panel.shotType | upper }}{% if panel.position %} — {{ panel.position }}{% endif %}): {{ panel.action }}
{% for char in panel.character_fingerprints %}
Character: {{ char }}
{% endfor %}
{% if panel.dialogue_lines | length %}
{% for line in panel.dialogue_lines %}
{% if line.type == 'thought' %}Thought bubble: {{ line.character }}: "{{ line.line }}"
{% elif line.type == 'narration' %}Narration box: "{{ line.line }}"
{% else %}Speech balloon: {{ line.character }}: "{{ line.line }}"
{% endif %}
{% endfor %}
{% endif %}
{% if panel.sfx %}Stylized SFX text integrated into the panel: "{{ panel.sfx }}"
{% endif %}
{% if panel.notes %}{{ panel.notes }}
{% endif %}
{% endfor %}
```

The template must handle:
- Style prefix (via include)
- Setting description (via include, for pages with establishing/wide shots)
- Panel count and layout description
- Per-panel: shot type (uppercased), action text, character fingerprints, dialogue lines (with type-appropriate labels), SFX, notes
- Splash pages (1 panel, note it's a full-page composition)
- Double spreads (1 panel, note it's a double-page spread)

**pipeline/data/templates/character-sheet.njk:**
```
{% include "partials/style-prefix.njk" %}

{{ reference_sheet_prompt }}

Layout:
Main Row: Four full-body views: Front View, 3/4 Angle View, Side Profile View, Back View.
```
Simple template for generating character reference sheet prompts. This is the Nunjucks-based version of what the `character ref-sheet` CLI command does via string concatenation in Plan 03.

**pipeline/src/templates/engine.ts:**
```typescript
export function createPromptEngine(templateDir: string): nunjucks.Environment {
  const env = new nunjucks.Environment(
    new nunjucks.FileSystemLoader(templateDir),
    {
      autoescape: false,       // Prompts are plain text, not HTML
      throwOnUndefined: true,  // Catch missing variables immediately
      trimBlocks: true,        // Remove newline after block tags
      lstripBlocks: true,      // Strip leading whitespace before block tags
    }
  );

  // Custom filters
  env.addFilter('upper', (str: string) => str.toUpperCase());

  return env;
}
```

Export `createPromptEngine`. Keep it minimal — the research explicitly warns against over-engineering the template system (pitfall #6).

Create pipeline/tests/templates/engine.test.ts:
- createPromptEngine creates a valid Nunjucks Environment
- Rendering style-prefix.njk returns the exact verbatim text
- Rendering setting-description.njk with a setting variable returns "Setting: {value}"
- Rendering page-prompt.njk with mock data produces expected output
- Rendering page-prompt.njk with has_establishing_shot=true includes setting text
- Rendering page-prompt.njk with has_establishing_shot=false omits setting text
- throwOnUndefined causes error when a variable is missing
- autoescape is disabled (no HTML escaping in prompts)
  </action>
  <verify>
Run `cd /Users/dondemetrius/Code/plasma/pipeline && pnpm run test:run -- tests/templates/engine.test.ts` — all tests pass. Run `pnpm run typecheck` — no type errors.
  </verify>
  <done>Nunjucks templates created matching the structure of hand-written prompts. Style prefix partial contains verbatim text. Setting description partial renders the setting from style-guide.yaml. Template engine configured for plain-text prompt output. Tests verify template rendering produces correct output including setting description inclusion/exclusion.</done>
</task>

<task type="auto">
  <name>Task 2: Build prompt generator (with setting wiring) and wire into prompt stage</name>
  <files>
    pipeline/src/templates/prompt-generator.ts
    pipeline/src/stages/prompt.ts
    pipeline/tests/templates/prompt-generator.test.ts
  </files>
  <action>
Create pipeline/src/templates/prompt-generator.ts:

```typescript
export interface PromptGeneratorOptions {
  chapter: Chapter;
  registry: CharacterRegistry;
  stylePrefix: string;
  setting: string;           // From style-guide.yaml 'setting' field
  templateDir: string;
}

export interface GeneratedPrompt {
  pageNumber: number;
  prompt: string;
  charactersIncluded: string[];  // Which characters had fingerprints injected
  charactersUnknown: string[];   // Characters mentioned but not in registry (warnings)
}

export function generateChapterPrompts(options: PromptGeneratorOptions): GeneratedPrompt[] {
  // 1. Create Nunjucks engine pointing at templateDir
  // 2. For each page in chapter:
  //    a. Extract character names from all panels (from dialogue speakers + action text matching)
  //    b. Look up each character in registry
  //    c. Determine if page has an establishing shot (any panel with shot type containing 'Wide' at page position 1, or isSplash on first page)
  //    d. Build template context:
  //       - panels with character_fingerprints resolved
  //       - layout_description
  //       - panel_count
  //       - setting (from options.setting)
  //       - has_establishing_shot (boolean — true if page has a Wide/establishing shot)
  //    e. Render page-prompt.njk with the context
  //    f. Return GeneratedPrompt with the rendered text and character tracking
  // 3. Return array of all page prompts
}
```

**Character extraction from panels:**
For each panel, detect which characters appear:
1. All dialogue line speakers are characters (exact: `panel.dialogue[].character`)
2. Match all registered character names/aliases against the action text (case-insensitive word boundary match)
3. Deduplicate. Characters found in the registry get their fingerprint injected. Characters NOT found produce a warning (minor characters like "registrar" or "commuters" don't need fingerprints).

**Layout description generation:**
Based on panel count and page type:
- Splash page: "Full-page splash composition"
- Double spread: "Double-page spread composition"
- 2-3 panels: "N-panel vertical layout"
- 4+ panels: "N-panel layout" with brief position hints derived from panel indices (e.g., "top row", "bottom row")

Match the natural language style of the hand-written prompts (e.g., "3-panel vertical layout. Top panel is a wide cinematic establishing shot...").

**Setting description wiring:**
Read BOTH `style_prefix` AND `setting` from pipeline/data/config/style-guide.yaml using the yaml package. Pass `setting` to the template context alongside `has_establishing_shot`. The setting-description.njk partial is conditionally included only when the page has an establishing/wide shot — this matches how the hand-written prompts include setting context only for establishing shots (e.g., Page 1's "London skyline, year 3031..."). For non-establishing pages, the setting is omitted to keep prompts focused on the panel content.

**Style prefix loading:**
Read `style_prefix` from pipeline/data/config/style-guide.yaml using the yaml package. Pass it to the template as a variable (NOT hardcoded in the template — the template uses `{% include "partials/style-prefix.njk" %}` instead). But also make it available as a variable for any template that needs it outside the include.

Replace the stub implementation in pipeline/src/stages/prompt.ts:

1. Read script.json from `output/ch-NN/script.json` (produced by the script stage). If it doesn't exist, return error telling user to run script stage first.
2. Load the CharacterRegistry from pipeline/data/characters/
3. Load the style guide from pipeline/data/config/style-guide.yaml — extract BOTH `style_prefix` AND `setting` fields
4. Call generateChapterPrompts with the parsed chapter, registry, style prefix, setting, and template directory
5. Write each GeneratedPrompt.prompt to `output/ch-NN/prompts/page-NN.txt` (one file per page)
6. Log summary: total pages, characters included, any unknown character warnings
7. Return StageResult with all prompt file paths in outputFiles

If `options.verbose`, log per-page details (characters injected, fingerprint inclusion status, whether setting was included).
If `options.dryRun`, generate prompts in memory but don't write files.

Create pipeline/tests/templates/prompt-generator.test.ts:
- generateChapterPrompts with a 1-page chapter produces 1 prompt
- Generated prompt starts with the style prefix text
- Generated prompt includes character fingerprints for known characters
- Generated prompt contains panel shot types in uppercase
- Characters not in registry appear in charactersUnknown
- Splash page prompt notes full-page composition
- Page with a Wide establishing shot includes the setting description text
- Page with only close-up shots does NOT include the setting description text
- Setting value from style-guide.yaml is passed through to template context
- Integration test: generate prompts for chapter 1 (requires script.json exists or load from real file) — produces 29 prompts
  </action>
  <verify>
Run `cd /Users/dondemetrius/Code/plasma/pipeline && pnpm run test:run -- tests/templates/` — all tests pass. First run `pnpm run stage:script -- -c 1` to ensure script.json exists, then run `pnpm run stage:prompt -- -c 1 --verbose` — should produce 29 files in output/ch-01/prompts/. Inspect output/ch-01/prompts/page-01.txt — should start with "Colored manga page, cel-shaded..." and include Spyke's fingerprint text. Verify page-01.txt (which has a Wide establishing shot) includes the setting description. Verify a non-establishing page omits the setting description.
  </verify>
  <done>Prompt stage generates 29 prompt files for chapter 1. Each prompt starts with the verbatim style prefix, includes character fingerprints for all known characters in the scene, and follows the same structure as the hand-written prompts. Pages with establishing shots include the setting description from style-guide.yaml. Unknown minor characters produce warnings, not errors.</done>
</task>

</tasks>

<verification>
- `cd pipeline && pnpm run typecheck` exits 0
- `cd pipeline && pnpm run test:run` — all tests pass
- `pnpm run stage:prompt -- -c 1` writes 29 files to output/ch-01/prompts/
- output/ch-01/prompts/page-01.txt starts with "Colored manga page, cel-shaded, clean linework, vibrant colors, dynamic panel layout."
- output/ch-01/prompts/page-01.txt contains Spyke's fingerprint text verbatim
- output/ch-01/prompts/page-01.txt contains setting description (has Wide establishing shot)
- output/ch-01/prompts/page-23.txt mentions splash/full-page composition
- A non-establishing page prompt does NOT contain "Setting:" line
- Editing pipeline/data/characters/spyke-tinwall.yaml fingerprint and re-running stage:prompt changes all prompts containing Spyke
- Editing pipeline/data/templates/partials/style-prefix.njk and re-running stage:prompt changes all prompts
- Editing the `setting` value in pipeline/data/config/style-guide.yaml and re-running stage:prompt updates setting descriptions in establishing-shot pages
</verification>

<success_criteria>
The prompt stage produces one Gemini-optimized prompt per page with the style guide prefix, setting descriptions (for establishing shots), and character fingerprints embedded automatically. The template library manages character blocks, style prefix, AND setting descriptions as reusable partials (PRMT-04). Prompts match the structure and quality of the hand-written prompts. Single-source updates (character YAML, style prefix, setting) propagate to all prompts on re-generation.
</success_criteria>

<output>
After completion, create `.planning/phases/02-scripts-characters-and-prompts/02-04-SUMMARY.md`
</output>
