---
phase: 02-scripts-characters-and-prompts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pipeline/package.json
  - pipeline/src/types/manga.ts
  - pipeline/src/types/characters.ts
  - pipeline/src/types/index.ts
  - pipeline/src/schemas/manga.schema.ts
  - pipeline/src/schemas/character.schema.ts
  - pipeline/src/config/paths.ts
autonomous: true
requirements: [SCRP-02, SCRP-03, CHAR-04]

must_haves:
  truths:
    - "Panel interface includes shotType, action, dialogue, sfx, notes fields"
    - "Page interface includes isSplash, isDoubleSpread flags"
    - "Chapter interface includes metadata (themeBeat, characters, locations)"
    - "CharacterFingerprint interface exists with id, name, aliases, fingerprint fields"
    - "Zod schemas validate parsed script data and reject invalid panel counts"
    - "Character schema validates YAML-parsed data and rejects missing fingerprints"
    - "All new dependencies install without errors"
  artifacts:
    - path: "pipeline/src/types/manga.ts"
      provides: "Expanded Panel, Page, Chapter interfaces with all fields"
      contains: "shotType"
    - path: "pipeline/src/types/characters.ts"
      provides: "CharacterFingerprint, DialogueLine types"
      exports: ["CharacterFingerprint", "DialogueLine"]
    - path: "pipeline/src/schemas/manga.schema.ts"
      provides: "Zod schemas for Panel, Page, Chapter validation"
      contains: "PanelSchema"
    - path: "pipeline/src/schemas/character.schema.ts"
      provides: "Zod schema for character YAML validation"
      contains: "CharacterFingerprintSchema"
    - path: "pipeline/src/config/paths.ts"
      provides: "New path constants for character data and templates"
      contains: "characters"
  key_links:
    - from: "pipeline/src/schemas/manga.schema.ts"
      to: "pipeline/src/types/manga.ts"
      via: "z.infer derives types from schemas"
      pattern: "z\\.infer"
    - from: "pipeline/src/schemas/character.schema.ts"
      to: "pipeline/src/types/characters.ts"
      via: "z.infer derives types from schemas"
      pattern: "z\\.infer"
    - from: "pipeline/src/types/index.ts"
      to: "pipeline/src/types/characters.ts"
      via: "barrel re-export"
      pattern: "export.*characters"
---

<objective>
Install Phase 2 dependencies and create the expanded type system and Zod validation schemas that all subsequent plans build on.

Purpose: Every plan in this phase depends on shared types (Panel, Page, Chapter, CharacterFingerprint) and validation schemas. Installing dependencies and defining types first prevents duplicate work and ensures type safety across the parser, registry, and template engine.

Output: Updated package.json with new dependencies, expanded manga types, new character types, Zod validation schemas, updated path config.
</objective>

<execution_context>
@/Users/dondemetrius/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dondemetrius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@pipeline/src/types/manga.ts
@pipeline/src/types/pipeline.ts
@pipeline/src/types/index.ts
@pipeline/src/config/paths.ts
@pipeline/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and expand types</name>
  <files>
    pipeline/package.json
    pipeline/src/types/manga.ts
    pipeline/src/types/characters.ts
    pipeline/src/types/index.ts
    pipeline/src/config/paths.ts
  </files>
  <action>
Install Phase 2 dependencies in pipeline/:
```bash
cd pipeline && pnpm add nunjucks yaml zod unified remark-parse unist-util-visit && pnpm add -D @types/nunjucks @types/mdast
```

Expand pipeline/src/types/manga.ts — replace the stub interfaces with full types matching the chapter-01-script.md format:

- `DialogueLine` interface: `character: string`, `line: string`, `type: 'speech' | 'thought' | 'narration'`
- `Panel` interface: `panelNumber: number`, `shotType: string`, `action: string`, `dialogue: DialogueLine[]`, `sfx: string`, `notes: string`, `tags: string[]` (remove old `id` and `description` fields)
- `Page` interface: `pageNumber: number`, `panels: Panel[]`, `isSplash: boolean`, `isDoubleSpread: boolean`
- `Chapter` interface: `chapterNumber: number`, `title: string`, `themeBeat: string`, `estimatedPages: number`, `characters: string[]`, `locations: string[]`, `pages: Page[]`

Create pipeline/src/types/characters.ts with:
- `CharacterFingerprint` interface: `id: string` (lowercase kebab-case), `name: string`, `aliases: string[]`, `fingerprint: string` (the verbatim prompt text), `reference_sheet_prompt?: string`, `palette?: { primary: string[], accent: string[] }`, `variants?: Record<string, string>`
- `CharacterRegistry` type: `Map<string, CharacterFingerprint>` (keyed by id and all aliases, case-insensitive)

Update pipeline/src/types/index.ts to re-export the new types:
- Add: `export type { CharacterFingerprint } from './characters.js';`
- Update manga re-exports to include `DialogueLine`

Update pipeline/src/config/paths.ts to add new path constants:
- `pipelineRoot`: path to `pipeline/` directory (two levels up from config/)
- `characterData`: `path.join(pipelineRoot, 'data', 'characters')` — where character YAML files live
- `templates`: `path.join(pipelineRoot, 'data', 'templates')` — where Nunjucks templates live
- `styleGuide`: `path.join(pipelineRoot, 'data', 'config', 'style-guide.yaml')` — style guide config
- Add `prompts` to `chapterOutput()`: `path.join(..., 'prompts')` — where generated prompts are written

Keep existing PATHS entries unchanged. Add the new ones alongside them.
  </action>
  <verify>
Run `cd /Users/dondemetrius/Code/plasma/pipeline && pnpm run typecheck` — must exit 0 with no errors. Verify nunjucks, yaml, zod, unified, remark-parse, unist-util-visit are in package.json dependencies. Verify @types/nunjucks, @types/mdast are in devDependencies.
  </verify>
  <done>All 7 new dependencies installed. manga.ts has expanded Panel/Page/Chapter with all fields. characters.ts exports CharacterFingerprint. paths.ts has characterData, templates, styleGuide paths. Typecheck passes.</done>
</task>

<task type="auto">
  <name>Task 2: Create Zod validation schemas with tests</name>
  <files>
    pipeline/src/schemas/manga.schema.ts
    pipeline/src/schemas/character.schema.ts
    pipeline/tests/schemas/manga.schema.test.ts
    pipeline/tests/schemas/character.schema.test.ts
  </files>
  <action>
Create pipeline/src/schemas/manga.schema.ts:

- `ShotType` enum: `z.enum(['Wide', 'Medium', 'Medium-Wide', 'Close-up', 'Extreme close-up', "Bird's eye", 'Low angle', 'Full Page', 'Full Double Spread', 'Black'])` — include all shot types from chapter-01-script.md including "Wide (Action)" style variants. Use `z.string()` for shotType field in PanelSchema to allow compound types like "Wide (Action)" that appear in the script.
- `DialogueLineSchema`: character string, line string, type enum (speech/thought/narration)
- `PanelSchema`: panelNumber (positive int), shotType (string — not the enum, because the script has compound types like "Wide (Action)"), action (min 1 char), dialogue (array of DialogueLineSchema), sfx (string), notes (string), tags (string array)
- `PageSchema` with refinement: if isSplash or isDoubleSpread, panels.length === 1. Otherwise panels.length >= 1 (not strictly 4-7 because action montages exist — research pitfall #2). Add a warning-level check that flags standard pages outside 4-7 range rather than rejecting them.
- `ChapterSchema` with refinement: must have at least one Wide shot type across all pages.

Create pipeline/src/schemas/character.schema.ts:

- `CharacterFingerprintSchema`: id (regex /^[a-z0-9-]+$/), name (min 1), aliases (string array, default []), fingerprint (min 20 chars — must be substantial), reference_sheet_prompt (optional string), palette (optional object with primary/accent string arrays), variants (optional record of strings)

Create pipeline/tests/schemas/manga.schema.test.ts with tests:
- Valid panel with all fields passes
- Panel with empty action fails
- Standard page with 4-7 panels passes
- Splash page with 1 panel passes
- Standard page with 0 panels fails
- Chapter with at least one Wide shot passes
- Chapter with no Wide shot fails
- Dialogue line with thought type passes

Create pipeline/tests/schemas/character.schema.test.ts with tests:
- Valid character with all fields passes
- Character with short fingerprint (<20 chars) fails
- Character with invalid id (uppercase, spaces) fails
- Character with missing name fails
- Character with optional fields omitted passes
- Aliases default to empty array when omitted

Note: Use Zod v4 import syntax (`import { z } from 'zod'`). Zod v4 uses z.infer for type inference. Schemas should export both the schema and the inferred type so other modules can import either.
  </action>
  <verify>
Run `cd /Users/dondemetrius/Code/plasma/pipeline && pnpm run test:run -- tests/schemas/` — all schema tests pass. Run `pnpm run typecheck` — no type errors.
  </verify>
  <done>Manga and character Zod schemas exist with custom refinements. 8+ tests pass covering valid data, edge cases (splash pages, compound shot types), and validation failures. Types are inferred from schemas via z.infer.</done>
</task>

</tasks>

<verification>
- `cd pipeline && pnpm run typecheck` exits 0
- `cd pipeline && pnpm run test:run` — all tests pass (existing 13 + new schema tests)
- `node -e "require('nunjucks')"` does not error (dependency installed)
- `pipeline/src/types/manga.ts` contains `shotType`, `dialogue`, `isSplash`, `isDoubleSpread`
- `pipeline/src/types/characters.ts` contains `CharacterFingerprint`
- `pipeline/src/schemas/` directory contains manga.schema.ts and character.schema.ts
</verification>

<success_criteria>
All Phase 2 dependencies installed. Expanded type system covers every field needed by the parser, registry, and template engine. Zod schemas validate parsed data with custom refinements for manga rules. All tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/02-scripts-characters-and-prompts/02-01-SUMMARY.md`
</output>
