---
phase: 02-scripts-characters-and-prompts
plan: 05
type: execute
wave: 3
depends_on: [02-02, 02-03]
files_modified:
  - pipeline/src/characters/qc.ts
  - pipeline/tests/characters/qc.test.ts
autonomous: true
requirements: [CHAR-02]

must_haves:
  truths:
    - "QC checklist reports which characters appear in each panel and whether their fingerprint was found"
    - "QC checklist flags characters mentioned in action text but missing from the registry"
    - "QC output is a readable markdown checklist"
    - "QC verifies that generated prompts actually contain the expected fingerprint text"
  artifacts:
    - path: "pipeline/src/characters/qc.ts"
      provides: "QC checklist generator for character-panel cross-referencing"
      exports: ["generateQCChecklist", "formatQCReport"]
    - path: "pipeline/tests/characters/qc.test.ts"
      provides: "QC checklist tests"
      min_lines: 40
  key_links:
    - from: "pipeline/src/characters/qc.ts"
      to: "pipeline/src/characters/registry.ts"
      via: "uses CharacterRegistry to look up fingerprints"
      pattern: "CharacterRegistry"
    - from: "pipeline/src/characters/qc.ts"
      to: "pipeline/src/types/manga.ts"
      via: "accepts Chapter object as input"
      pattern: "Chapter"
---

<objective>
Build the per-panel QC checklist that cross-references characters in the parsed script against the character registry and verifies their fingerprints appear in generated prompts.

Purpose: Character consistency is the hardest problem in AI manga generation. The QC checklist provides a systematic verification mechanism — instead of eyeballing each prompt, the pipeline reports exactly which characters were found, which had fingerprints injected, and which are missing from the registry. This catches fingerprint gaps before images are generated.

Output: QC module that generates a markdown checklist report for a chapter, verifying character coverage.
</objective>

<execution_context>
@/Users/dondemetrius/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dondemetrius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-scripts-characters-and-prompts/02-02-SUMMARY.md
@.planning/phases/02-scripts-characters-and-prompts/02-03-SUMMARY.md
@pipeline/src/types/manga.ts
@pipeline/src/types/characters.ts
@pipeline/src/characters/registry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build QC checklist generator with markdown output</name>
  <files>
    pipeline/src/characters/qc.ts
    pipeline/tests/characters/qc.test.ts
  </files>
  <action>
Create pipeline/src/characters/qc.ts:

```typescript
export interface QCChecklistItem {
  pageNumber: number;
  panelNumber: number;
  character: string;
  hasFingerprint: boolean;       // Character exists in registry
  hasReferenceSheet: boolean;    // Character has reference_sheet_prompt
  fingerprintIncluded: boolean;  // Fingerprint text found in the generated prompt
  notes: string;                 // Warning notes
}

export interface QCReport {
  chapterNumber: number;
  totalPanels: number;
  totalCharacterAppearances: number;
  knownCharacters: number;
  unknownCharacters: string[];
  missingFingerprints: number;   // Known character but fingerprint not in prompt
  items: QCChecklistItem[];
}
```

Implement `generateQCChecklist(chapter: Chapter, registry: CharacterRegistry, generatedPrompts: string[]): QCReport`:

1. For each page in the chapter:
   - Get the corresponding generated prompt text (by page index)
   - For each panel in the page:
     - Extract character names from dialogue speakers and action text (same logic as prompt-generator's character extraction)
     - For each character found:
       - Check if character exists in registry (`hasFingerprint`)
       - Check if character has reference_sheet_prompt (`hasReferenceSheet`)
       - Check if the character's fingerprint text appears in the generated prompt (`fingerprintIncluded`) — do a substring match of `char.fingerprint.trim()` against the prompt text
       - Build notes: "WARNING: No fingerprint found" for unknown chars, "WARNING: Fingerprint not included in prompt" for known chars whose text is missing
2. Aggregate stats: total panels, total character appearances, unique unknown characters, missing fingerprint count

Implement `formatQCReport(report: QCReport): string` that produces readable markdown:

```markdown
# QC Report: Chapter N

## Summary
- Total panels: X
- Character appearances: X
- Known characters: X
- Unknown characters: X (list)
- Missing fingerprints in prompts: X

## Checklist

### Page 1
| Panel | Character | In Registry | Ref Sheet | In Prompt | Notes |
|-------|-----------|-------------|-----------|-----------|-------|
| 1 | Spyke | yes | yes | yes | |
| 3 | Punk 1 | no | no | no | No fingerprint found |

### Page 2
...
```

Pages with all characters resolved show a checkmark summary. Pages with issues are highlighted.

Create pipeline/tests/characters/qc.test.ts:
- QC checklist correctly identifies known characters (in registry)
- QC checklist correctly identifies unknown characters (not in registry)
- QC checklist verifies fingerprint text appears in prompt
- QC report summary counts are accurate
- formatQCReport produces valid markdown with table formatting
- Empty chapter (no panels) produces empty checklist without errors
- Chapter 1 integration: load real registry, parse real script, check QC report has expected character counts
  </action>
  <verify>
Run `cd /Users/dondemetrius/Code/plasma/pipeline && pnpm run test:run -- tests/characters/qc.test.ts` — all QC tests pass. Run `pnpm run typecheck` — no type errors.
  </verify>
  <done>QC checklist generator cross-references characters against registry and verifies fingerprint inclusion in prompts. Produces readable markdown report. Flags unknown characters with warnings. All tests pass.</done>
</task>

</tasks>

<verification>
- `cd pipeline && pnpm run typecheck` exits 0
- `cd pipeline && pnpm run test:run -- tests/characters/` — all tests pass
- QC report correctly identifies Spyke, June, Draster, Hood as known characters
- QC report flags minor characters (Punk 1, Registrar, etc.) as unknown with warnings
- formatQCReport produces valid markdown tables
</verification>

<success_criteria>
The QC checklist systematically verifies that every character appearing in a chapter's panels is either covered by the fingerprint system or flagged as a known gap. The report is machine-readable and human-scannable.
</success_criteria>

<output>
After completion, create `.planning/phases/02-scripts-characters-and-prompts/02-05-SUMMARY.md`
</output>
