---
phase: 06-spyke-dataset-preparation
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - pipeline/src/scripts/crop-spyke.ts
  - dataset/spyke/train/10_spyke_plasma_v1/.gitkeep
autonomous: true
requirements:
  - DATA-01
  - DATA-04

must_haves:
  truths:
    - "Running `tsx pipeline/src/scripts/crop-spyke.ts --dry-run` produces preview crop images in dataset/spyke/train/10_spyke_plasma_v1/preview/ without writing final outputs"
    - "Crop coordinates for all source images are documented and visible in the script's CROPS config object"
    - "The script letterboxes each crop to exactly 512×512 using Sharp's contain fit with white background"
    - "Dataset directory structure (10_spyke_plasma_v1, preview/) exists on disk"
  artifacts:
    - path: "pipeline/src/scripts/crop-spyke.ts"
      provides: "Crop tool with dry-run + final modes, coordinates for all source images"
      exports: []
    - path: "dataset/spyke/train/10_spyke_plasma_v1/.gitkeep"
      provides: "Directory placeholder committed to git"
  key_links:
    - from: "pipeline/src/scripts/crop-spyke.ts"
      to: "03_manga/concept/characters/spyke_tinwall/Spyke_Final.png"
      via: "sharp().extract(crop).resize(512, 512, { fit: 'contain' })"
      pattern: "extract.*resize"
    - from: "pipeline/src/scripts/crop-spyke.ts"
      to: "dataset/spyke/train/10_spyke_plasma_v1/preview/"
      via: "writeFile in dry-run mode"
      pattern: "dry.run|dryRun|dry_run"
---

<objective>
Build the Spyke crop script with documented coordinates for all source images. Run `--dry-run` to produce preview crops the user can inspect before committing to final output.

Purpose: Dataset curation starts with exact crop coordinates. The dry-run output gives the user visual proof that each crop captures the right part of the character before anything is finalized. The script is the primary tool for DATA-01 and DATA-04 (flip augmentation is pre-generated in Plan 02 after approval).

Output: `pipeline/src/scripts/crop-spyke.ts` with coordinate tables for Spyke_Final.png and three clean ref-sheets; preview images in `dataset/spyke/train/10_spyke_plasma_v1/preview/`.
</objective>

<execution_context>
@/Users/dondemetrius/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dondemetrius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/dondemetrius/Code/plasma/.planning/PROJECT.md
@/Users/dondemetrius/Code/plasma/.planning/ROADMAP.md
@/Users/dondemetrius/Code/plasma/.planning/STATE.md
@/Users/dondemetrius/Code/plasma/.planning/phases/06-spyke-dataset-preparation/06-RESEARCH.md
@/Users/dondemetrius/Code/plasma/pipeline/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dataset directory structure and crop script</name>
  <files>
    pipeline/src/scripts/crop-spyke.ts
    dataset/spyke/train/10_spyke_plasma_v1/.gitkeep
    dataset/spyke/train/10_spyke_plasma_v1/preview/.gitkeep
    dataset/spyke/reg/1_anime_character/.gitkeep
  </files>
  <action>
Create `pipeline/src/scripts/crop-spyke.ts` using `sharp` (already in dependencies at ^0.34.5). Use `tsx pipeline/src/scripts/crop-spyke.ts` to run.

The script has two modes controlled by a `--dry-run` flag (parsed manually from `process.argv` — do NOT add Commander just for this standalone script):
- `--dry-run`: Crop all images → save previews to `dataset/spyke/train/10_spyke_plasma_v1/preview/` → print summary. Does NOT write to the final output directory.
- (no flag): Final mode — crops to `dataset/spyke/train/10_spyke_plasma_v1/` directly.

Define a `CROP_SOURCES` array at the top of the file. Each entry has:
```typescript
interface CropSource {
  id: string;           // e.g. 'spyke_final_front'
  src: string;          // absolute or repo-relative path to source image
  crop: { left: number; top: number; width: number; height: number };
  flip?: boolean;       // true = this crop is also safe to flip (symmetric subject)
  caption: string;      // caption text for the .txt file (written in Plan 02, documented here)
}
```

Use these exact coordinates (from research — MEDIUM confidence, dry-run must be verified by user):

**From `03_manga/concept/characters/spyke_tinwall/Spyke_Final.png` (2816×1536):**
- `spyke_final_front`:   { left: 30,   top: 100,  width: 640, height: 1120 }, flip: false, caption: "spyke_plasma_v1, full body, front view, standing neutral, white background"
- `spyke_final_3q`:      { left: 720,  top: 100,  width: 640, height: 1120 }, flip: false, caption: "spyke_plasma_v1, full body, three quarter angle, standing, white background"
- `spyke_final_side`:    { left: 1400, top: 100,  width: 640, height: 1120 }, flip: false, caption: "spyke_plasma_v1, full body, side profile, standing, white background"
- `spyke_final_back`:    { left: 2080, top: 100,  width: 640, height: 1120 }, flip: true,  caption: "spyke_plasma_v1, full body, back view, white cloak visible, white background"
- `spyke_final_neutral`: { left: 30,   top: 1230, width: 380, height: 280  }, flip: true,  caption: "spyke_plasma_v1, closeup face, neutral expression, white background"
- `spyke_final_angry`:   { left: 430,  top: 1230, width: 380, height: 280  }, flip: true,  caption: "spyke_plasma_v1, closeup face, angry expression, white background"
- `spyke_final_battle`:  { left: 850,  top: 1230, width: 380, height: 280  }, flip: true,  caption: "spyke_plasma_v1, closeup face, battle focus expression, white background"
- `spyke_final_shocked`: { left: 1680, top: 1230, width: 380, height: 280  }, flip: true,  caption: "spyke_plasma_v1, closeup face, shocked expression, white background"

**From `output/characters/spyke-tinwall/ref-sheet-v1.png` (1024×1024) — clean white bg, 4 views across width:**
- `v1_front`:  { left: 10,  top: 60, width: 240, height: 900 }, flip: false, caption: "spyke_plasma_v1, full body, front view, standing, white background"
- `v1_3q`:     { left: 270, top: 60, width: 240, height: 900 }, flip: false, caption: "spyke_plasma_v1, full body, three quarter angle, standing, white background"
- `v1_side`:   { left: 530, top: 60, width: 240, height: 900 }, flip: false, caption: "spyke_plasma_v1, full body, side profile, standing, white background"
- `v1_back`:   { left: 790, top: 60, width: 240, height: 900 }, flip: true,  caption: "spyke_plasma_v1, full body, back view, white cloak visible, white background"

**From `output/characters/spyke-tinwall/ref-sheet-v7.png` (1024×1024) — latest, clean:**
- `v7_front`:  { left: 10,  top: 60, width: 240, height: 900 }, flip: false, caption: "spyke_plasma_v1, full body, front view, standing, white background"
- `v7_3q`:     { left: 270, top: 60, width: 240, height: 900 }, flip: false, caption: "spyke_plasma_v1, full body, three quarter angle, standing, white background"
- `v7_side`:   { left: 530, top: 60, width: 240, height: 900 }, flip: false, caption: "spyke_plasma_v1, full body, side profile, standing, white background"
- `v7_back`:   { left: 790, top: 60, width: 240, height: 900 }, flip: true,  caption: "spyke_plasma_v1, full body, back view, white cloak visible, white background"

**From `output/characters/spyke-tinwall/ref-sheet-v2.png` (1024×1024) — secondary clean:**
- `v2_front`:  { left: 10,  top: 60, width: 240, height: 900 }, flip: false, caption: "spyke_plasma_v1, full body, front view, standing, white background"
- `v2_back`:   { left: 790, top: 60, width: 240, height: 900 }, flip: true,  caption: "spyke_plasma_v1, full body, back view, white cloak visible, white background"

Total: 18 crop sources. That is within the 15-20 target.

**Processing each crop:**
```typescript
await sharp(src)
  .extract(crop)
  .resize(512, 512, {
    fit: 'contain',
    background: { r: 255, g: 255, b: 255, alpha: 1 },
  })
  .png()
  .toFile(outputPath);
```

Output filename in final mode: `spyke_NNN.png` where NNN is zero-padded index (001, 002, ...).
Output filename in dry-run preview: `preview_${source.id}.png` — preserves id for identification.

Print a table after all crops complete showing: id, source, output filename, flip eligible.

Also create `dataset/spyke/train/10_spyke_plasma_v1/.gitkeep`, `dataset/spyke/train/10_spyke_plasma_v1/preview/.gitkeep`, and `dataset/spyke/reg/1_anime_character/.gitkeep` so the directory structure is committed.

Source paths must be relative to project root. Resolve with `path.resolve(process.cwd(), ...)` — the script is run from the project root (`/Users/dondemetrius/Code/plasma`).

Do NOT use `@stable-canvas/comfyui-client` in this script — that is for Plan 03 only. This script only needs `sharp`, `node:fs/promises`, and `node:path`.
  </action>
  <verify>
Run from project root:
```bash
cd /Users/dondemetrius/Code/plasma
tsx pipeline/src/scripts/crop-spyke.ts --dry-run
```
Expected: Script completes without error. `dataset/spyke/train/10_spyke_plasma_v1/preview/` contains 18 PNG files (preview_spyke_final_front.png through preview_v2_back.png). Script prints a summary table. No files written to the final output directory (only preview/).
  </verify>
  <done>
18 preview crop PNGs exist in `dataset/spyke/train/10_spyke_plasma_v1/preview/`. The crop script exits 0 in dry-run mode. The CROPS config table is visible at the top of the script file.
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/dondemetrius/Code/plasma
tsx pipeline/src/scripts/crop-spyke.ts --dry-run
ls dataset/spyke/train/10_spyke_plasma_v1/preview/ | wc -l  # expect 18
ls dataset/spyke/reg/1_anime_character/                      # expect .gitkeep
```
</verification>

<success_criteria>
`crop-spyke.ts` script exists and runs cleanly in dry-run mode. 18 preview PNGs are present in the preview directory. User can open any preview PNG and see a 512×512 letterboxed crop of the expected Spyke reference area. Directory scaffolding committed.
</success_criteria>

<output>
After completion, create `.planning/phases/06-spyke-dataset-preparation/06-01-SUMMARY.md` following the summary template at `@/Users/dondemetrius/.claude/get-shit-done/templates/summary.md`.

Include in summary:
- Which source images were successfully cropped in dry-run
- Any crops that failed (wrong dimensions, file not found)
- Note that crop coordinates are MEDIUM confidence and need user visual review in Plan 02
- Phase 8 blocker: `~/tools/kohya_ss/sd-scripts/` is empty — run `cd ~/tools/kohya_ss && git submodule update --init --recursive` before Phase 8
</output>
