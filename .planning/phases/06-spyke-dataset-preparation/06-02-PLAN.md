---
phase: 06-spyke-dataset-preparation
plan: "02"
type: execute
wave: 2
depends_on:
  - "06-01"
files_modified:
  - pipeline/src/scripts/crop-spyke.ts
  - dataset/spyke/train/10_spyke_plasma_v1/spyke_001.png
  - dataset/spyke/train/10_spyke_plasma_v1/spyke_001.txt
  - .gitignore
autonomous: false

requirements:
  - DATA-01
  - DATA-02
  - DATA-04

must_haves:
  truths:
    - "dataset/spyke/train/10_spyke_plasma_v1/ contains 15–20 PNG files at exactly 512×512"
    - "Every training PNG has a paired .txt caption file starting with 'spyke_plasma_v1'"
    - "Flipped copies exist ONLY for crops with flip: true in the source config (back view, face closeups)"
    - "No flipped copies exist for front/3q/side views that show the right bracer or left knee pauldron"
    - ".gitignore excludes dataset/**/*.png but NOT dataset/**/*.txt"
    - "Caption format matches: trigger_word, framing, pose/action, background type"
  artifacts:
    - path: "dataset/spyke/train/10_spyke_plasma_v1/"
      provides: "15–20 training PNGs + paired .txt caption files"
      contains: "spyke_plasma_v1"
    - path: ".gitignore"
      provides: "Excludes dataset PNG images, includes caption .txt files"
      contains: "dataset/**/*.png"
  key_links:
    - from: "dataset/spyke/train/10_spyke_plasma_v1/spyke_NNN.png"
      to: "dataset/spyke/train/10_spyke_plasma_v1/spyke_NNN.txt"
      via: "same filename stem, different extension"
      pattern: "spyke_\\d{3}\\.(png|txt)"
    - from: "dataset/spyke/train/10_spyke_plasma_v1/spyke_NNN_flip.png"
      to: "dataset/spyke/train/10_spyke_plasma_v1/spyke_NNN_flip.txt"
      via: "flip-suffixed pairs for symmetric crops only"
      pattern: "_flip\\.(png|txt)"
---

<objective>
Human reviews the dry-run preview crops from Plan 01 and approves/rejects/adjusts coordinates. Claude then runs final crop generation, writes caption `.txt` files for every image, and generates pre-flipped copies for symmetric-only crops (DATA-04). Updates `.gitignore` to exclude PNG images but commit captions.

Purpose: The human approval checkpoint prevents bad training data from being committed. After approval, all three DATA-01, DATA-02, and DATA-04 requirements are satisfied as disk artifacts.

Output: 15–20 final training PNGs + paired `.txt` captions + flip copies for eligible images. `.gitignore` updated.
</objective>

<execution_context>
@/Users/dondemetrius/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dondemetrius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/dondemetrius/Code/plasma/.planning/PROJECT.md
@/Users/dondemetrius/Code/plasma/.planning/ROADMAP.md
@/Users/dondemetrius/Code/plasma/.planning/phases/06-spyke-dataset-preparation/06-RESEARCH.md
@/Users/dondemetrius/Code/plasma/.planning/phases/06-spyke-dataset-preparation/06-01-SUMMARY.md
@/Users/dondemetrius/Code/plasma/pipeline/src/scripts/crop-spyke.ts
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Review dry-run preview crops and approve coordinates</name>
  <files>dataset/spyke/train/10_spyke_plasma_v1/preview/</files>
  <action>Human opens preview PNGs and approves or adjusts crop coordinates before final generation runs. See how-to-verify for full checklist.</action>
  <what-built>
Up to 19 preview crop images from Plan 01, located at:
`dataset/spyke/train/10_spyke_plasma_v1/preview/`

Each PNG is a 512×512 letterboxed crop from one of these sources:
- `Spyke_Final.png`: 4 body views (front, 3q, side, back) + 5 expression faces (neutral, angry, battle-focus, calm, shocked)
  - NOTE: `preview_spyke_final_calm.png` is speculative — its coordinates assume a 5th panel exists in the ~830px gap in the expression row. It may show a blank region or overlap an adjacent panel.
- `ref-sheet-v1.png`: 4 body views (clean white bg)
- `ref-sheet-v7.png`: 4 body views (latest clean version)
- `ref-sheet-v2.png`: 2 body views (front, back)
  </what-built>
  <how-to-verify>
Open each preview PNG in `dataset/spyke/train/10_spyke_plasma_v1/preview/` and check:

1. **Body crops (front/3q/side/back):** Does the full character fit in frame? Is the head not cut off? Are feet visible?
2. **Asymmetric details visible:** In front/3q view, can you see the right bracer and left knee pauldron?
3. **Annotation text:** Do any crops from `Spyke_Final.png` have heavy callout text overlaying the character? If so, note which IDs.
4. **Expression face crops:** Are the 5 faces (neutral, angry, battle-focus, calm, shocked) readable at 512×512? **Calm expression check (required):** Does `preview_spyke_final_calm.png` show a distinct calm/relaxed expression, or is it blank, a duplicate of an adjacent panel, or mostly empty white space? If no distinct calm panel exists, EXCLUDE this crop — `neutral` can serve as the calm analog. Confirm your decision explicitly in your approval message.
5. **Duplicate poses:** Are `v1_front`, `v7_front`, and `v2_front` too similar? If so, we can drop one.
6. **Overall quality:** Any crops blurry, incorrectly framed, or missing major character features?

For each problematic crop, note:
- The crop `id` (e.g., `spyke_final_front`, `v1_3q`)
- What's wrong
- Whether to: EXCLUDE it, KEEP it as-is, or ADJUST coordinates (provide new left/top/width/height)

If all previews look good, type: "approved — all N look good"
If some need changes: "approved with changes: [list each crop id and what to do]"
  </how-to-verify>
  <verify>Preview PNGs exist in `dataset/spyke/train/10_spyke_plasma_v1/preview/` and user has reviewed them, including an explicit decision on whether `spyke_final_calm` shows a distinct expression</verify>
  <done>User has typed "approved" (with optional adjustment list) and has addressed the calm expression question</done>
  <resume-signal>Type "approved" (optionally with changes list) to proceed, or describe which crops to fix. Must include a verdict on spyke_final_calm: keep or exclude.</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Apply crop adjustments, run final crops, write captions, generate flips</name>
  <files>
    pipeline/src/scripts/crop-spyke.ts
    dataset/spyke/train/10_spyke_plasma_v1/spyke_001.png
    dataset/spyke/train/10_spyke_plasma_v1/spyke_001.txt
    .gitignore
  </files>
  <action>
**Step A — Apply user's crop adjustments** (if any were given in the checkpoint):
Update coordinates or remove excluded crops from the `CROP_SOURCES` array in `pipeline/src/scripts/crop-spyke.ts`. This includes removing `spyke_final_calm` if the user determined no distinct calm panel exists (in that case, `spyke_final_neutral` serves as the calm analog). If coordinates were adjusted, re-run `--dry-run` to confirm fix before proceeding to final output. Skip this step if user approved all previews unchanged.

**Step B — Run final crop generation** (no `--dry-run` flag):
```bash
cd /Users/dondemetrius/Code/plasma
tsx pipeline/src/scripts/crop-spyke.ts
```
This writes final `spyke_001.png`, `spyke_002.png`, ... to `dataset/spyke/train/10_spyke_plasma_v1/`. Count should be 15–20 after any exclusions.

**Step C — Generate pre-flipped copies using Sharp** (DATA-04):
For every `CropSource` with `flip: true` in the CROP_SOURCES array, generate a horizontally flipped copy. Write an inline script or extend `crop-spyke.ts` with a `--flip` flag:

```typescript
// For each image in dataset/spyke/train/10_spyke_plasma_v1/ whose source had flip: true:
await sharp(originalPath)
  .flop()   // horizontal flip
  .png()
  .toFile(flippedPath);  // filename: spyke_NNN_flip.png
```

Flipped copies eligible (flip: true in the config): back view crops and all face closeups.
NOT flipped: front, 3q, and side body views (these show right bracer / left knee pauldron — asymmetric).

**Step D — Write caption .txt files** for EVERY image (original + flipped):
Each `.txt` file has the same stem as its corresponding `.png`. Content from the `caption` field in `CropSource`. For flipped copies, append `, mirrored` to the caption. Example:
```
spyke_003.txt:       spyke_plasma_v1, full body, back view, white cloak visible, white background
spyke_003_flip.txt:  spyke_plasma_v1, full body, back view, white cloak visible, white background, mirrored
```

Captions must be written as a single line, comma-separated, no trailing newlines.

**Step E — Update .gitignore** at project root:
Add this entry if not already present:
```
# LoRA dataset images (regeneratable — not committed)
dataset/**/*.png
```
Caption .txt files are NOT excluded — they should be committed.

**Step F — Verify final counts:**
```bash
ls dataset/spyke/train/10_spyke_plasma_v1/*.png | wc -l   # total PNG count
ls dataset/spyke/train/10_spyke_plasma_v1/*.txt | wc -l   # must equal PNG count
```
Total PNG count should be 15–20 (originals) + N flips where N = count of flip:true sources that were kept.
  </action>
  <verify>
```bash
cd /Users/dondemetrius/Code/plasma
# Training image count (originals only, no flip suffix)
ls dataset/spyke/train/10_spyke_plasma_v1/spyke_*.png | grep -v flip | wc -l
# Must be 15–20

# Every PNG has a matching .txt
for f in dataset/spyke/train/10_spyke_plasma_v1/*.png; do
  txt="${f%.png}.txt"
  [ -f "$txt" ] || echo "MISSING: $txt"
done
# Must print nothing (no missing captions)

# All captions start with trigger word
grep -rL "^spyke_plasma_v1" dataset/spyke/train/10_spyke_plasma_v1/*.txt
# Must print nothing (empty output = all have trigger word)

# .gitignore excludes PNGs
grep "dataset/\*\*/\*.png" .gitignore
# Must print the pattern
```
  </verify>
  <done>
15–20 final training PNGs exist. Every PNG has a paired `.txt` caption starting with `spyke_plasma_v1`. Flipped copies exist only for back-view and face-closeup crops (not front/3q/side). `.gitignore` excludes `dataset/**/*.png`. Zero missing caption files reported.
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/dondemetrius/Code/plasma
# Original training images: 15-20
ls dataset/spyke/train/10_spyke_plasma_v1/spyke_*.png | grep -v flip | wc -l

# Caption parity check
for f in dataset/spyke/train/10_spyke_plasma_v1/*.png; do
  [ -f "${f%.png}.txt" ] || echo "MISSING CAPTION: $f"
done

# No front/3q/side flips (those show asymmetric details)
ls dataset/spyke/train/10_spyke_plasma_v1/*_flip.png 2>/dev/null | xargs -I{} basename {}
# Should only show back/face flips

# Trigger word in all captions
grep -c "^spyke_plasma_v1" dataset/spyke/train/10_spyke_plasma_v1/*.txt | grep -v ":1$" || echo "All captions OK"
```
</verification>

<success_criteria>
Training dataset directory contains 15–20 original Spyke images at 512×512 plus flip copies for symmetric poses only. Every image has a valid caption file. `.gitignore` correctly excludes PNG images while caption `.txt` files remain committed. DATA-01, DATA-02, and DATA-04 are satisfied. Expression variety confirmed: neutral, determined (battle-focus), surprised (shocked), angry, and calm (or neutral serving as calm analog if no distinct panel exists) are represented.
</success_criteria>

<output>
After completion, create `.planning/phases/06-spyke-dataset-preparation/06-02-SUMMARY.md`.

Include:
- Final training image count (originals + flips)
- List of excluded crops and why (e.g., "spyke_final_front excluded — annotation text too heavy")
- Whether spyke_final_calm was kept or excluded, and what serves as the calm expression in the dataset
- List of flip-eligible crops that received flipped copies
- Final caption samples (first 3 captions as examples)
- Reminder: .gitignore excludes PNGs; caption .txt files ARE committed
</output>
