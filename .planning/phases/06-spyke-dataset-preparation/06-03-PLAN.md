---
phase: 06-spyke-dataset-preparation
plan: "03"
type: execute
wave: 1
depends_on: []
files_modified:
  - pipeline/src/scripts/gen-reg.ts
  - dataset/spyke/reg/1_anime_character/reg_001.png
autonomous: false

requirements:
  - DATA-03

must_haves:
  truths:
    - "Running the gen-reg script posts jobs to ComfyUI and saves PNG outputs to dataset/spyke/reg/1_anime_character/"
    - "At least 100 reg images exist in the reg directory after the script completes"
    - "No .txt caption files exist in the reg directory (kohya_ss uses folder class token for reg images)"
    - "Each reg image uses a unique random seed (no identical duplicates)"
    - "The script handles ComfyUI job failure gracefully — retries once, then skips and continues"
  artifacts:
    - path: "pipeline/src/scripts/gen-reg.ts"
      provides: "TypeScript regularization image generator using ComfyUI REST API"
      exports: []
    - path: "dataset/spyke/reg/1_anime_character/"
      provides: "100–200 generic anime character PNG images at 512×512"
  key_links:
    - from: "pipeline/src/scripts/gen-reg.ts"
      to: "http://127.0.0.1:8188/prompt"
      via: "fetch POST with workflow JSON"
      pattern: "fetch.*127\\.0\\.0\\.1:8188"
    - from: "pipeline/src/scripts/gen-reg.ts"
      to: "dataset/spyke/reg/1_anime_character/"
      via: "direct filesystem read from ComfyUI output dir + writeFile"
      pattern: "writeFile.*reg_"
---

<objective>
Build the regularization image generator script and run it to produce 100–200 generic anime character images in `dataset/spyke/reg/1_anime_character/`. Uses ComfyUI's REST API with raw fetch + polling (no new npm packages). No `.txt` captions in the reg directory.

Purpose: DATA-03 requires a regularization dataset generated from the base model with no LoRA. These images teach kohya_ss what "anime_character" looks like without `spyke_plasma_v1`, preserving class separation during training.

Output: `pipeline/src/scripts/gen-reg.ts` + 100 PNG files in reg directory.
</objective>

<execution_context>
@/Users/dondemetrius/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dondemetrius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/dondemetrius/Code/plasma/.planning/PROJECT.md
@/Users/dondemetrius/Code/plasma/.planning/ROADMAP.md
@/Users/dondemetrius/Code/plasma/.planning/phases/06-spyke-dataset-preparation/06-RESEARCH.md
@/Users/dondemetrius/Code/plasma/pipeline/package.json
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Checkpoint: Start ComfyUI before regularization generation</name>
  <action>Start ComfyUI before the regularization generator script can run</action>
  <instructions>
ComfyUI must be running at `http://127.0.0.1:8188` before the generator script is started. The generator will immediately fail with ECONNREFUSED if ComfyUI is not up.

To start ComfyUI:
```bash
cd ~/tools/ComfyUI
source venv/bin/activate
python main.py --listen 127.0.0.1 --port 8188
```

Leave this running in a separate terminal tab. The generator script will run for 15–20 minutes (100 images × ~10–15s each on M1 Pro MPS). You do not need to interact with ComfyUI during generation — it runs headlessly.

Once ComfyUI is running and you see "Starting server..." in its terminal output:
  </instructions>
  <resume-signal>Type "comfyui ready" to proceed with script creation and generation run</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Create gen-reg.ts script and run 100-image regularization generation</name>
  <files>
    pipeline/src/scripts/gen-reg.ts
    dataset/spyke/reg/1_anime_character/reg_001.png
  </files>
  <action>
Create `pipeline/src/scripts/gen-reg.ts`. Uses ONLY built-in Node.js `fetch` (available since Node 18 — no node-fetch needed), `node:fs/promises`, `node:path`, and `node:crypto`. Do NOT add `@stable-canvas/comfyui-client`, `ws`, or `node-fetch` to package.json — raw fetch + polling is simpler and has zero new deps (per research recommendation).

**Script design:**

```typescript
// Config at top of file
const COMFYUI_URL = 'http://127.0.0.1:8188';
const OUTPUT_DIR = 'dataset/spyke/reg/1_anime_character';
const COMFYUI_OUTPUT_DIR = `${process.env.HOME}/tools/ComfyUI/output`;
const TARGET_COUNT = 100;   // Override with --count N flag
const POLL_INTERVAL_MS = 2000;
const TIMEOUT_MS = 120_000; // 2 minutes per image

const REG_PROMPT = [
  'anime character, 1boy, young man, generic fantasy warrior',
  'standing pose, full body, white background',
  'anime style, clean lineart, flat shading',
  'masterpiece, best quality',
].join(', ');

const REG_NEGATIVE = [
  'spyke_plasma_v1',
  'red bandana, white cloak',
  'ginger hair, red hair',
  'lowres, bad anatomy, bad hands, text, error, missing fingers',
  'extra digit, fewer digits, cropped, worst quality, low quality',
  'signature, watermark, username, blurry',
].join(', ');
```

**Workflow JSON builder** — returns the ComfyUI API-format workflow object with a randomized seed:
```typescript
function buildWorkflow(seed: number): Record<string, unknown> {
  return {
    "1": { class_type: "CheckpointLoaderSimple", inputs: { ckpt_name: "AnythingXL_inkBase.safetensors" } },
    "2": { class_type: "CLIPTextEncode", inputs: { text: REG_PROMPT, clip: ["1", 1] } },
    "3": { class_type: "CLIPTextEncode", inputs: { text: REG_NEGATIVE, clip: ["1", 1] } },
    "4": { class_type: "EmptyLatentImage", inputs: { width: 512, height: 512, batch_size: 1 } },
    "5": { class_type: "KSampler", inputs: {
        model: ["1", 0], positive: ["2", 0], negative: ["3", 0],
        latent_image: ["4", 0], seed, steps: 20, cfg: 7,
        sampler_name: "euler_ancestral", scheduler: "normal", denoise: 1 }},
    "6": { class_type: "VAEDecode", inputs: { samples: ["5", 0], vae: ["1", 2] } },
    "7": { class_type: "SaveImage", inputs: { images: ["6", 0], filename_prefix: "comfy_reg" } },
  };
}
```

**generateOne function:**
1. POST `{ prompt: workflow, client_id: randomUUID() }` to `${COMFYUI_URL}/prompt`
2. Extract `prompt_id` from response JSON
3. Poll `${COMFYUI_URL}/history/${prompt_id}` every 2s until history entry exists OR timeout
4. On success: read the output filename from `history[prompt_id].outputs["7"].images[0]`
5. ComfyUI saves to its own output dir. Read directly from filesystem: `${COMFYUI_OUTPUT_DIR}/${img.filename}`
6. Copy to `OUTPUT_DIR/reg_NNN.png` using `fs.copyFile`
7. On timeout/failure: log warning, return without saving, continue loop (skip-and-continue strategy)

**Main loop:**
```typescript
async function main() {
  const countArg = process.argv.indexOf('--count');
  const targetCount = countArg !== -1 ? parseInt(process.argv[countArg + 1]) : TARGET_COUNT;

  await fs.mkdir(path.resolve(OUTPUT_DIR), { recursive: true });

  // Count already-existing reg images to support resume
  const existing = (await fs.readdir(path.resolve(OUTPUT_DIR)))
    .filter(f => f.endsWith('.png')).length;

  console.log(`Starting regularization generation: target=${targetCount}, existing=${existing}`);

  let saved = existing;
  let attempted = 0;
  while (saved < targetCount) {
    attempted++;
    const seed = Math.floor(Math.random() * 2 ** 32);
    const index = saved + 1;
    process.stdout.write(`[${saved}/${targetCount}] Generating reg_${String(index).padStart(3,'0')}.png (seed=${seed})...`);
    try {
      await generateOne(seed, path.resolve(OUTPUT_DIR, `reg_${String(index).padStart(3,'0')}.png`));
      saved++;
      process.stdout.write(' done\n');
    } catch (err) {
      process.stdout.write(` FAILED (${(err as Error).message}) — skipping\n`);
    }
  }
  console.log(`\nComplete: ${saved} reg images in ${OUTPUT_DIR}`);
}
```

**Script args:**
- `--count N`: override target (default 100). Use `--count 5` to test the script end-to-end with 5 images before committing to the full run.

After writing the script, verify it runs with 5 images first:
```bash
cd /Users/dondemetrius/Code/plasma
tsx pipeline/src/scripts/gen-reg.ts --count 5
```

If 5 images complete, run the full batch:
```bash
tsx pipeline/src/scripts/gen-reg.ts --count 100
```

The full 100-image run takes approximately 15–20 minutes on M1 Pro MPS (10–15s per image). Let it run to completion. The script supports resume (skips existing files by counting them at startup).

Do NOT add any npm packages. Use only built-in Node.js APIs. The script runs with `tsx` which is already in devDependencies.
  </action>
  <verify>
```bash
cd /Users/dondemetrius/Code/plasma
# Check image count
ls dataset/spyke/reg/1_anime_character/*.png 2>/dev/null | wc -l
# Must be 100 or more

# Confirm no caption files in reg dir (would contaminate kohya_ss training)
ls dataset/spyke/reg/1_anime_character/*.txt 2>/dev/null | wc -l
# Must be 0

# Spot check: first image is valid PNG at 512×512 (not corrupt)
tsx -e "import sharp from 'sharp'; sharp('dataset/spyke/reg/1_anime_character/reg_001.png').metadata().then(m => console.log(m.width, m.height, m.format))"
# Must print: 512 512 png
```
  </verify>
  <done>
100 PNG files exist in `dataset/spyke/reg/1_anime_character/`. Zero `.txt` files in that directory. First image is a valid 512×512 PNG. DATA-03 satisfied.
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/dondemetrius/Code/plasma
ls dataset/spyke/reg/1_anime_character/*.png | wc -l     # 100+
ls dataset/spyke/reg/1_anime_character/*.txt 2>/dev/null | wc -l  # 0
tsx -e "import sharp from 'sharp'; sharp('dataset/spyke/reg/1_anime_character/reg_001.png').metadata().then(m => console.log('Size:', m.width, 'x', m.height))"
# Size: 512 x 512
```
</verification>

<success_criteria>
`gen-reg.ts` script exists and uses raw fetch + polling against ComfyUI REST API (no new npm packages). 100 regularization PNG images exist in `dataset/spyke/reg/1_anime_character/`. No caption `.txt` files in the reg directory. DATA-03 satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/06-spyke-dataset-preparation/06-03-SUMMARY.md`.

Include:
- Total reg images generated
- Time taken for full generation run
- Any failures/skips during generation
- Checkpoint: whether reg images visually look like generic anime characters (spot-check)
- Confirm: no .txt files in reg directory
</output>
