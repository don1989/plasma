---
phase: 06-spyke-dataset-preparation
plan: "04"
type: execute
wave: 3
depends_on:
  - "06-02"
  - "06-03"
files_modified:
  - pipeline/src/scripts/validate-dataset.ts
autonomous: false

requirements:
  - DATA-01
  - DATA-02
  - DATA-03
  - DATA-04

must_haves:
  truths:
    - "validate-dataset.ts exits 0 with no errors when the dataset is complete and correct"
    - "Training image count is 15–20 (originals) before including flips"
    - "Every training PNG has a paired .txt caption file"
    - "Every caption starts with spyke_plasma_v1"
    - "Regularization image count is 100–200"
    - "No .txt files exist in the reg directory"
    - "All training images are exactly 512×512 PNG"
    - "User visually confirms training images show Spyke with correct costume details"
  artifacts:
    - path: "pipeline/src/scripts/validate-dataset.ts"
      provides: "Dataset validation script — checks counts, pairing, trigger word, image dimensions"
      exports: []
  key_links:
    - from: "pipeline/src/scripts/validate-dataset.ts"
      to: "dataset/spyke/train/10_spyke_plasma_v1/"
      via: "readdirSync + sharp metadata check"
      pattern: "readdirSync.*10_spyke"
    - from: "pipeline/src/scripts/validate-dataset.ts"
      to: "dataset/spyke/reg/1_anime_character/"
      via: "readdirSync count"
      pattern: "readdirSync.*1_anime"
---

<objective>
Build a dataset validation script that programmatically verifies all DATA-01 through DATA-04 requirements. Run it, fix any errors, then do a human visual spot-check of training images to confirm Spyke's asymmetric costume details are visible.

Purpose: Phase 8 (LoRA training) has no tolerance for dataset errors. A bad caption, wrong image count, or missing trigger word discovered mid-training means stopping and repeating Phase 6. This validation catches those issues now.

Output: `validate-dataset.ts` script that exits 0 when the dataset is valid; passing validation run documented in summary.
</objective>

<execution_context>
@/Users/dondemetrius/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dondemetrius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/dondemetrius/Code/plasma/.planning/PROJECT.md
@/Users/dondemetrius/Code/plasma/.planning/ROADMAP.md
@/Users/dondemetrius/Code/plasma/.planning/phases/06-spyke-dataset-preparation/06-RESEARCH.md
@/Users/dondemetrius/Code/plasma/.planning/phases/06-spyke-dataset-preparation/06-02-SUMMARY.md
@/Users/dondemetrius/Code/plasma/.planning/phases/06-spyke-dataset-preparation/06-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create and run dataset validation script</name>
  <files>
    pipeline/src/scripts/validate-dataset.ts
  </files>
  <action>
Create `pipeline/src/scripts/validate-dataset.ts`. Uses `sharp`, `node:fs`, `node:path` only (no new deps).

The script validates all four DATA requirements and prints a human-readable report:

```typescript
import { readdirSync, readFileSync, existsSync } from 'node:fs';
import path from 'node:path';
import sharp from 'sharp';

const TRAIN_DIR = 'dataset/spyke/train/10_spyke_plasma_v1';
const REG_DIR = 'dataset/spyke/reg/1_anime_character';
const TRIGGER_WORD = 'spyke_plasma_v1';
const TRAIN_MIN = 15;
const TRAIN_MAX = 20;  // originals only (flips don't count toward target)
const REG_MIN = 100;
const REG_MAX = 200;
```

**Checks to implement:**

1. **Directory existence** — both TRAIN_DIR and REG_DIR exist, fail fast if not.

2. **DATA-01: Training image count** — count `*.png` files in TRAIN_DIR excluding `*_flip.png`. Must be 15–20. Report count even if passing.

3. **DATA-02: Caption pairing and format** — for every `*.png` in TRAIN_DIR (including flips):
   - Paired `.txt` must exist with same stem
   - `.txt` content (trimmed) must start with `spyke_plasma_v1`
   - `.txt` must have at least 4 comma-separated tokens (trigger, framing, pose, background)
   - Report each violation as an error

4. **DATA-03: Reg image count** — count `*.png` in REG_DIR. Must be 100–200.
   - Also verify: zero `.txt` files in REG_DIR (warn if any exist)

5. **DATA-04: Flip image existence** — count `*_flip.png` in TRAIN_DIR. Must be > 0 (at least some flips were generated). Report count.

6. **Image dimension check** (async) — sample first 5 training images + first 5 reg images. Use `sharp(f).metadata()` to confirm `width === 512 && height === 512`. Report any that differ.

**Output format:**
```
=== Spyke Dataset Validation ===

DATA-01: Training images (originals only)   [PASS] 18 images (min: 15, max: 20)
DATA-02: Caption pairing                    [PASS] 24/24 images have valid captions
DATA-02: Trigger word                       [PASS] All 24 captions start with spyke_plasma_v1
DATA-02: Caption format (4+ tokens)        [PASS] All captions have 4+ comma-separated fields
DATA-03: Regularization images              [PASS] 100 images (min: 100)
DATA-03: No captions in reg dir             [PASS] 0 .txt files found
DATA-04: Flip augmentation images           [PASS] 10 flip images (back views + faces)
DIMENSIONS: Training sample (5 images)      [PASS] All 512x512
DIMENSIONS: Reg sample (5 images)           [PASS] All 512x512

=================================
Result: PASS (0 errors, 0 warnings)
```

If any check fails, print `[FAIL]` for that line and print specific failing filenames below it. Exit code 1 if any FAIL, exit code 0 if all PASS.

After writing the script, run it:
```bash
cd /Users/dondemetrius/Code/plasma
tsx pipeline/src/scripts/validate-dataset.ts
```

If any checks fail, fix the issues (rerun crop-spyke.ts, regenerate reg images, fix captions) and re-run validation until all PASS. Do not move to the checkpoint task until validation exits 0.
  </action>
  <verify>
```bash
cd /Users/dondemetrius/Code/plasma
tsx pipeline/src/scripts/validate-dataset.ts
echo "Exit code: $?"
# Must print "Result: PASS" and exit code 0
```
  </verify>
  <done>
`validate-dataset.ts` exits 0 with "Result: PASS" and zero errors. All DATA-01 through DATA-04 checks pass programmatically.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Visual verification of final training and regularization dataset</name>
  <files>
    dataset/spyke/train/10_spyke_plasma_v1/
    dataset/spyke/reg/1_anime_character/
  </files>
  <action>Human visually inspects training images for Spyke costume accuracy and reg images for generic character quality. Automated validation (Task 1) must have passed before this checkpoint runs.</action>
  <what-built>
Complete Spyke LoRA training dataset:
- `dataset/spyke/train/10_spyke_plasma_v1/` — 15–20 training images + caption files + flip copies
- `dataset/spyke/reg/1_anime_character/` — 100 regularization images
- Automated validation: all DATA-01 through DATA-04 checks PASS
  </what-built>
  <how-to-verify>
1. Open a sample of 5–6 training images from `dataset/spyke/train/10_spyke_plasma_v1/`. Check:
   - **Right bracer**: visible in front-facing images
   - **Left knee pauldron**: visible in front-facing images
   - **White cloak**: present and recognizable
   - **Ginger hair**: clear hair color
   - **No heavy annotation text** overlaying the character

2. Open 2–3 caption `.txt` files and confirm they follow the format:
   `spyke_plasma_v1, [framing], [pose], [background]`

3. Open 2–3 images from `dataset/spyke/reg/1_anime_character/`. Check:
   - Generic anime character (NOT Spyke — no red bandana, no white cloak)
   - Full body, white background
   - 512×512 resolution

4. Confirm flip copies exist for back-view and face images but NOT for front/3q/side body views.

5. Confirm the validation script output (shown in terminal before this checkpoint) reads "Result: PASS".

If anything looks wrong, describe the issue. Claude will fix and re-run validation.
  </how-to-verify>
  <verify>User has opened and reviewed training images, captions, and reg images for quality</verify>
  <done>User types "dataset approved" — all four DATA requirements are satisfied and visually confirmed</done>
  <resume-signal>Type "dataset approved" to mark Phase 6 complete, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
```bash
cd /Users/dondemetrius/Code/plasma
tsx pipeline/src/scripts/validate-dataset.ts
# Expected: Result: PASS, exit 0

# Final count summary
echo "Training originals: $(ls dataset/spyke/train/10_spyke_plasma_v1/*.png 2>/dev/null | grep -v flip | wc -l | tr -d ' ')"
echo "Training flips:     $(ls dataset/spyke/train/10_spyke_plasma_v1/*_flip.png 2>/dev/null | wc -l | tr -d ' ')"
echo "Reg images:         $(ls dataset/spyke/reg/1_anime_character/*.png 2>/dev/null | wc -l | tr -d ' ')"
echo "Caption files:      $(ls dataset/spyke/train/10_spyke_plasma_v1/*.txt 2>/dev/null | wc -l | tr -d ' ')"
```
</verification>

<success_criteria>
Validation script exits 0 with all DATA-01 through DATA-04 checks PASS. User approves dataset in visual verification. Phase 6 is complete and Phase 8 (Spyke LoRA Training) is unblocked. Phase 8 blocker note documented in summary: `~/tools/kohya_ss/sd-scripts/` must have submodule initialized before training.
</success_criteria>

<output>
After completion, create `.planning/phases/06-spyke-dataset-preparation/06-04-SUMMARY.md`.

Include:
- Final validation output (copy of the PASS report)
- Final dataset counts (training originals, flips, reg images, captions)
- Human verification outcome
- **PHASE 8 BLOCKER** section: `cd ~/tools/kohya_ss && git submodule update --init --recursive` must be run before Phase 8 begins. `train_network.py` is missing because sd-scripts submodule was not initialized during Phase 5.
- State: Phase 6 complete, Phase 8 unblocked (pending sd-scripts fix)
</output>
