---
phase: 04-assembly-and-publish
plan: 02
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - pipeline/src/types/overlay.ts
  - pipeline/src/assembly/strip-builder.ts
  - pipeline/src/assembly/slicer.ts
  - pipeline/src/assembly/output.ts
  - pipeline/src/stages/assemble.ts
  - pipeline/src/cli.ts
autonomous: true
requirements:
  - ASSM-01
  - ASSM-02
  - ASSM-03
  - ASSM-04

must_haves:
  truths:
    - "Running `assemble -c 1` reads lettered PNGs from lettered/ and produces 800x1280 JPEG strips in webtoon/"
    - "Output JPEG strips use mozjpeg at quality 90, producing files well under 2MB each"
    - "Splash pages are assembled at full 800px width with their natural taller aspect ratio"
    - "Double-spread pages are resized to 800px wide preserving aspect ratio (shorter, not distorted)"
    - "Assembly stage never writes to raw/ or lettered/ — reads from lettered/, writes only to webtoon/"
    - "Vertical strip has black gutters between panels (configurable height)"
    - "Strip filenames follow convention: ch01_strip_001.jpg, ch01_strip_002.jpg, etc."
  artifacts:
    - path: "pipeline/src/assembly/strip-builder.ts"
      provides: "Vertical panel stacking with configurable gutters and splash/double-spread handling"
      exports: ["assembleVerticalStrip"]
    - path: "pipeline/src/assembly/slicer.ts"
      provides: "800x1280 strip slicing with Sharp extract"
      exports: ["sliceForWebtoon"]
    - path: "pipeline/src/assembly/output.ts"
      provides: "Output configuration and format constants for Webtoon Canvas"
      exports: ["WEBTOON_CONFIG", "AssemblyConfig"]
    - path: "pipeline/src/stages/assemble.ts"
      provides: "Stage entry point reading lettered/ images and writing webtoon/ strips"
      exports: ["runAssemble"]
  key_links:
    - from: "pipeline/src/assembly/strip-builder.ts"
      to: "output/ch-NN/lettered/"
      via: "Reads lettered PNG images in page order"
      pattern: "readdir.*lettered|sharp.*lettered"
    - from: "pipeline/src/assembly/strip-builder.ts"
      to: "sharp composite"
      via: "Composites panels onto blank 800px-wide canvas at cumulative Y offsets"
      pattern: "sharp.*create.*width.*800.*composite"
    - from: "pipeline/src/assembly/slicer.ts"
      to: "sharp extract"
      via: "Extracts 800x1280px regions from tall strip buffer"
      pattern: "sharp.*extract.*1280"
    - from: "pipeline/src/stages/assemble.ts"
      to: "output/ch-NN/webtoon/"
      via: "Writes final JPEG strip files to webtoon/ directory"
      pattern: "webtoon.*toFile|writeFile"
    - from: "pipeline/src/stages/assemble.ts"
      to: "pipeline/src/stages/overlay.ts"
      via: "Reads overlay output from lettered/ (overlay must run first)"
      pattern: "lettered"
---

<objective>
Build the Webtoon assembly stage that stacks lettered panel images vertically, handles splash pages and double-spreads, and slices the result into 800x1280px Webtoon Canvas-compatible JPEG strips.

Purpose: This is the final pipeline stage — converting lettered panel images into publish-ready Webtoon episodes. The assembler handles the physical layout (vertical stacking with gutters), special page types (splash and double-spread), and the final output format (800x1280 JPEG strips optimized for Webtoon Canvas upload).

Output: Assembly module (`pipeline/src/assembly/`) with strip builder, slicer, and output config. Updated assemble stage and CLI with format/quality options.
</objective>

<execution_context>
@/Users/dondemetrius/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dondemetrius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-assembly-and-publish/04-RESEARCH.md
@.planning/phases/04-assembly-and-publish/04-01-SUMMARY.md

@pipeline/src/types/manga.ts
@pipeline/src/types/overlay.ts
@pipeline/src/types/pipeline.ts
@pipeline/src/config/paths.ts
@pipeline/src/stages/assemble.ts
@pipeline/src/cli.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create assembly modules — strip builder, slicer, and output config</name>
  <files>
    pipeline/src/types/overlay.ts
    pipeline/src/assembly/strip-builder.ts
    pipeline/src/assembly/slicer.ts
    pipeline/src/assembly/output.ts
  </files>
  <action>
Create the three assembly modules and extend types:

**1. Extend `pipeline/src/types/overlay.ts`** — Add assembly-specific types:
- `AssemblyConfig`: `{ width: number; gutterHeight: number; gutterColor: { r: number; g: number; b: number; alpha: number }; sliceHeight: number; jpegQuality: number; format: 'jpeg' | 'png' }`
- Export a `WEBTOON_CONFIG` constant: `{ width: 800, gutterHeight: 10, gutterColor: { r: 0, g: 0, b: 0, alpha: 1 }, sliceHeight: 1280, jpegQuality: 90, format: 'jpeg' }`
- `PanelMetadata`: `{ path: string; width: number; height: number; pageNumber: number; isSplash: boolean; isDoubleSpread: boolean }`
- `AssemblyResult`: `{ stripBuffer: Buffer; totalHeight: number; panelCount: number }`

**2. `pipeline/src/assembly/output.ts`** — Re-export config and provide format helpers:
- Re-export `WEBTOON_CONFIG` and `AssemblyConfig` from types for convenience
- Export `formatOutputFilename(chapter: number, stripIndex: number, format: 'jpeg' | 'png'): string` — returns `ch01_strip_001.jpg` pattern with zero-padded chapter (2 digits), strip index (3 digits), and correct extension (jpg for jpeg, png for png)
- Export `validateStripDimensions(width: number, height: number): { valid: boolean; warnings: string[] }` — checks width is 800, height is at most 1280, warns if file would likely exceed 2MB (height * width * 3 bytes > 2MB threshold as rough estimate)

**3. `pipeline/src/assembly/strip-builder.ts`** — Vertical panel stacking:
- Export `assembleVerticalStrip(panels: PanelMetadata[], config?: AssemblyConfig): Promise<AssemblyResult>`
- For each panel:
  1. Read image with `sharp(panel.path)`
  2. **Double-spread handling**: If `panel.isDoubleSpread`, resize to `config.width` wide using `sharp().resize(config.width, null, { fit: 'inside' })` — preserves aspect ratio, making the panel shorter than standard width
  3. **Splash handling**: If `panel.isSplash`, resize to `config.width` wide preserving aspect ratio (same as double-spread but expected to produce a taller panel)
  4. **Standard panels**: Resize to `config.width` wide preserving aspect ratio
  5. Get resized dimensions via `metadata()` after resize, or calculate: `scaledHeight = Math.round(originalHeight * (config.width / originalWidth))`
- Calculate `totalHeight` = sum of all scaled panel heights + `(panelCount - 1) * config.gutterHeight`
- Create blank canvas: `sharp({ create: { width: config.width, height: totalHeight, channels: 4, background: config.gutterColor } })`
- Composite each panel at cumulative Y offset using `sharp().composite(composites)` — each composite entry is `{ input: resizedBuffer, top: yOffset, left: 0 }`
- Return `{ stripBuffer, totalHeight, panelCount }`
- Log warning if `totalHeight` exceeds 100,000px (would produce 78+ strips, approaching Webtoon's possible 100-image limit)

**4. `pipeline/src/assembly/slicer.ts`** — Strip slicing:
- Export `sliceForWebtoon(stripBuffer: Buffer, outputDir: string, chapter: number, config?: AssemblyConfig): Promise<string[]>`
- Read total height from `sharp(stripBuffer).metadata()`
- Loop from `top = 0` to `totalHeight` in steps of `config.sliceHeight` (1280):
  1. Calculate slice height: `Math.min(config.sliceHeight, totalHeight - top)` (last slice may be shorter)
  2. Extract region: `sharp(stripBuffer).extract({ left: 0, top, width: config.width, height: sliceHeight })`
  3. If format is `'jpeg'`: apply `.jpeg({ quality: config.jpegQuality, mozjpeg: true })`
  4. If format is `'png'`: apply `.png()`
  5. Write to `outputDir` using `formatOutputFilename(chapter, stripIndex, config.format)`
  6. Collect output paths
- Return array of written file paths

Use ESM `.js` extensions. Use `import type` for type-only imports. Import Sharp as default import (`import sharp from 'sharp'`).
  </action>
  <verify>
Run `cd /Users/dondemetrius/Code/plasma/pipeline && npx tsc --noEmit` — no type errors.
Verify all 4 files exist: `types/overlay.ts` (extended), `assembly/strip-builder.ts`, `assembly/slicer.ts`, `assembly/output.ts`.
Verify exports: `assembleVerticalStrip`, `sliceForWebtoon`, `formatOutputFilename`, `WEBTOON_CONFIG`.
  </verify>
  <done>
Assembly modules exist with strip builder handling splash/double-spread aspect ratios, slicer producing 800x1280 JPEG strips, and output config matching Webtoon Canvas specifications. All pass type checking.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire assemble stage and expand CLI with format options</name>
  <files>
    pipeline/src/stages/assemble.ts
    pipeline/src/cli.ts
  </files>
  <action>
Replace the assemble stage stub and expand CLI:

**1. `pipeline/src/stages/assemble.ts`** — Replace the stub:
- Read `script.json` from `PATHS.chapterOutput(chapter).root` via `readFile` + `JSON.parse` to get `Chapter` data (needed for page metadata: isSplash, isDoubleSpread)
- Read lettered directory `PATHS.chapterOutput(chapter).lettered` via `readdir`
- Filter for `.png` and `.jpg` files, sort by filename to maintain page order
- For each lettered image, build `PanelMetadata`:
  1. Extract page number from filename (e.g., `ch01_p003_v1.png` -> page 3) using `parsePanelImageFilename` from `generation/naming.ts`
  2. Look up corresponding page in `chapter.pages` to get `isSplash` and `isDoubleSpread` flags
  3. Read dimensions via `sharp(path).metadata()`
- Call `assembleVerticalStrip(panels, config)` to produce the tall strip
- Call `sliceForWebtoon(stripBuffer, webtoonDir, chapter, config)` to slice into Webtoon strips
- Use `ensureDir` to create `webtoon/` directory
- Log summary: total panels assembled, total strip height, number of output slices, output format
- Return `StageResult` with success status, list of output files, any errors/warnings
- Support `--dry-run` (log dimensions and strip count without writing) and `--verbose` (log each panel's dimensions and placement)
- If lettered/ directory is empty or missing, return error: "No lettered images found. Run overlay stage first."

**2. `pipeline/src/cli.ts`** — Expand assemble subcommand:
- Add `--format <type>` option with choices `'jpeg'` and `'png'` (default: `'jpeg'`)
- Add `--quality <number>` option for JPEG quality (default: `90`, range 1-100)
- Add `--gutter <number>` option for gutter height in pixels (default: `10`)
- Pass these to `runAssemble` by building an `AssemblyConfig` override from CLI flags
- Keep existing `-c, --chapter`, `-v, --verbose`, `--dry-run` options

Follow the existing CLI pattern: options parsed in cli.ts, passed to stage function, stage handles all logic. No stage logic in cli.ts.
  </action>
  <verify>
Run `cd /Users/dondemetrius/Code/plasma/pipeline && npx tsc --noEmit` — no type errors.
Run `cd /Users/dondemetrius/Code/plasma/pipeline && npx tsx src/cli.ts assemble -c 1 --dry-run` — should execute without crashes (will report no lettered images found since overlay hasn't run).
Verify `pipeline/src/stages/assemble.ts` imports from `../assembly/strip-builder.js`, `../assembly/slicer.js`, `../assembly/output.js`.
Verify CLI help: `npx tsx src/cli.ts assemble --help` shows --format, --quality, --gutter options.
  </verify>
  <done>
Assembly stage reads lettered PNGs, handles splash/double-spread pages, stacks panels vertically with gutters, slices into 800x1280 Webtoon strips, and outputs JPEG with mozjpeg. CLI supports format, quality, and gutter customization. Running overlay then assemble produces a complete Webtoon episode from raw panel images.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx tsx src/cli.ts assemble -c 1 --dry-run` runs without crashes
3. `npx tsx src/cli.ts assemble --help` shows --format, --quality, --gutter options
4. Assembly stage reads only from `lettered/`, writes only to `webtoon/` — no upstream overwrites
5. Strip builder resizes double-spread panels to 800px wide preserving aspect ratio (not distorting)
6. Slicer produces 800x1280 JPEG strips with mozjpeg quality 90
7. Output filenames follow `ch01_strip_001.jpg` convention
</verification>

<success_criteria>
The assembly stage is fully functional: given lettered panel images from the overlay stage, it produces Webtoon Canvas-compatible 800x1280px JPEG strips at quality 90 with mozjpeg compression. Splash pages and double-spreads are handled with correct aspect ratios. The full pipeline (overlay -> assemble) transforms raw panel images into publish-ready Webtoon episode strips.
</success_criteria>

<output>
After completion, create `.planning/phases/04-assembly-and-publish/04-02-SUMMARY.md`
</output>
